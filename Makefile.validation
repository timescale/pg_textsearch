# Makefile for BM25 validation system
# This file manages the template-based validation of BM25 scores

# Python paths
PYTHON := python3
TEMPLATE_PROCESSOR := test/python/process_templates.py

# Database connection parameters
DB_HOST ?= localhost
DB_PORT ?= 5432
# Use a dedicated test database for validation to avoid data loss
DB_NAME ?= pg_textsearch_test
DB_USER ?= $(shell whoami)

# Directories
SQL_DIR := test/sql
EXPECTED_DIR := test/expected

# List of all template files (without .template extension)
TEMPLATES := aerodocs basic index limits mixed queries \
             scoring1 scoring2 scoring3 scoring4 scoring5 scoring6 \
             validation_test vector

# Derived file lists
TEMPLATE_FILES := $(addprefix $(SQL_DIR)/,$(addsuffix .sql.template,$(TEMPLATES)))
SQL_FILES := $(addprefix $(SQL_DIR)/,$(addsuffix .sql,$(TEMPLATES)))
EXPECTED_FILES := $(addprefix $(EXPECTED_DIR)/,$(addsuffix .out,$(TEMPLATES)))

# Default target
.PHONY: all
all: setup-test-db validate-all generate-expected

# Create test database if it doesn't exist
.PHONY: setup-test-db
setup-test-db:
	@echo "Setting up test database '$(DB_NAME)'..."
	@psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$(DB_NAME)'" | grep -q 1 || \
		(echo "Creating test database '$(DB_NAME)'..." && \
		 createdb -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) $(DB_NAME))
	@echo "Test database ready"

# Clean test database (drop all tables once at the beginning)
.PHONY: clean-test-db
clean-test-db: setup-test-db
	@echo "Cleaning test database '$(DB_NAME)'..."
	@psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -d $(DB_NAME) -c \
		"DO \$$\$$ \
		DECLARE r RECORD; \
		BEGIN \
		  FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') \
		  LOOP \
		    EXECUTE 'DROP TABLE IF EXISTS public.' || quote_ident(r.tablename) || ' CASCADE'; \
		  END LOOP; \
		END \$$\$$;"
	@echo "Test database cleaned"

# Process all templates
.PHONY: validate-all
validate-all: clean-test-db clean-validation $(SQL_FILES)
	@echo "All templates have been processed"

# Rule to process individual templates
$(SQL_DIR)/%.sql: $(SQL_DIR)/%.sql.template
	@echo "Processing template: $<"
	@$(PYTHON) $(TEMPLATE_PROCESSOR) \
		--host $(DB_HOST) \
		--port $(DB_PORT) \
		--database $(DB_NAME) \
		--user $(DB_USER) \
		"$<" "$@"

# Generate expected output files
.PHONY: generate-expected
generate-expected: $(SQL_FILES)
	@echo "Generating expected output files..."
	@for sql in $(SQL_FILES); do \
		base=$$(basename $$sql .sql); \
		out=$(EXPECTED_DIR)/$${base}.out; \
		echo "Generating $$out from $$sql"; \
		psql -a -h $(DB_HOST) -p $(DB_PORT) -d $(DB_NAME) -U $(DB_USER) \
			-f $$sql > $$out 2>&1 || true; \
	done

# Clean generated files
.PHONY: clean-validation
clean-validation:
	@echo "Cleaning validation files..."
	rm -f $(SQL_FILES)
	rm -f $(EXPECTED_FILES)

# List all templates
.PHONY: list-templates
list-templates:
	@echo "Available templates:"
	@for t in $(TEMPLATES); do echo "  - $$t.sql.template"; done

# Process a specific template (usage: make validate-one TEMPLATE=scoring1)
.PHONY: validate-one
validate-one: setup-test-db
ifndef TEMPLATE
	@echo "Error: TEMPLATE variable not set"
	@echo "Usage: make validate-one TEMPLATE=scoring1"
	@exit 1
endif
	@$(MAKE) -f Makefile.validation $(SQL_DIR)/$(TEMPLATE).sql

# Check if Python dependencies are installed
.PHONY: check-deps
check-deps:
	@echo "Checking Python dependencies..."
	@$(PYTHON) -c "import rank_bm25" 2>/dev/null || \
		(echo "Error: rank-bm25 not installed. Run: pip install rank-bm25" && exit 1)
	@$(PYTHON) -c "import psycopg2" 2>/dev/null || \
		(echo "Error: psycopg2 not installed. Run: pip install psycopg2-binary" && exit 1)
	@echo "All dependencies are installed"

# Run validation tests (compare actual vs expected)
.PHONY: test-validation
test-validation: $(SQL_FILES)
	@echo "Running validation tests..."
	@for sql in $(SQL_FILES); do \
		base=$$(basename $$sql .sql); \
		expected=$(EXPECTED_DIR)/$${base}.out; \
		actual=/tmp/$${base}_actual.out; \
		echo "Testing $$base..."; \
		psql -h $(DB_HOST) -p $(DB_PORT) -d $(DB_NAME) -U $(DB_USER) \
			-f $$sql > $$actual 2>&1; \
		if diff -u $$expected $$actual > /dev/null; then \
			echo "  ✓ PASS: $$base"; \
		else \
			echo "  ✗ FAIL: $$base"; \
			echo "    Run: diff -u $$expected $$actual"; \
		fi; \
		rm -f $$actual; \
	done

# Help target
.PHONY: help
help:
	@echo "BM25 Validation System Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  all              - Process all templates (default)"
	@echo "  validate-all     - Process all template files"
	@echo "  validate-one     - Process a specific template (requires TEMPLATE=name)"
	@echo "  generate-expected - Generate expected output files"
	@echo "  test-validation  - Run validation tests"
	@echo "  clean-validation - Remove generated files"
	@echo "  check-deps       - Check Python dependencies"
	@echo "  list-templates   - List available templates"
	@echo "  help            - Show this help message"
	@echo ""
	@echo "Environment variables:"
	@echo "  DB_HOST - Database host (default: localhost)"
	@echo "  DB_PORT - Database port (default: 5432)"
	@echo "  DB_NAME - Database name (default: pg_textsearch_test)"
	@echo "  DB_USER - Database user (default: current user)"
	@echo ""
	@echo "IMPORTANT: This system uses a dedicated test database by default."
	@echo "  The test database will be created if it doesn't exist."
	@echo "  ALL TABLES in the test database will be dropped during validation!"
	@echo "  To use a different database, set DB_NAME=your_db_name"
	@echo ""
	@echo "Examples:"
	@echo "  make -f Makefile.validation validate-all"
	@echo "  make -f Makefile.validation validate-one TEMPLATE=scoring1"
	@echo "  make -f Makefile.validation generate-expected DB_NAME=test_db"
