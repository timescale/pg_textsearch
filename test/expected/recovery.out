-- Test crash recovery functionality
-- This test verifies that the Tapir index can recover properly after a crash
-- by rebuilding posting lists from stored docid pages
CREATE EXTENSION IF NOT EXISTS tapir;
NOTICE:  extension "tapir" already exists, skipping
-- Clean up from any previous tests
DROP TABLE IF EXISTS crash_test_docs CASCADE;
NOTICE:  table "crash_test_docs" does not exist, skipping
-- Create a test table with various document types
CREATE TABLE crash_test_docs (
    id SERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    category VARCHAR(50)
);
-- Insert test documents with overlapping terms to test posting list merging
INSERT INTO crash_test_docs (content, category) VALUES
('the quick brown fox jumps over the lazy dog', 'animal'),
('a quick brown fox is very fast and agile', 'animal'),
('the lazy dog sleeps under the brown tree', 'animal'),
('database systems provide fast query processing', 'tech'),
('fast database queries need good indexing', 'tech'),
('indexing improves database query performance', 'tech'),
('brown bears are large and powerful animals', 'animal'),
('quick database lookups require efficient indexes', 'tech'),
('the fox and the dog are common animals', 'animal'),
('database performance depends on good design', 'tech');
-- Create the Tapir index which will populate posting lists
CREATE INDEX crash_test_idx ON crash_test_docs USING tapir(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  Tapir index build started for relation crash_test_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 10 documents, avg_length=5.30, text_config='english' (k1=1.20, b=0.75)
-- Verify the index works before "crash"
SELECT id, content, content <@> to_tpvector('quick fox', 'crash_test_idx') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('quick fox', 'crash_test_idx') > 0
ORDER BY score DESC
LIMIT 5;
 id | content | score 
----+---------+-------
(0 rows)

-- Test search for common term
SELECT id, content, content <@> to_tpvector('database', 'crash_test_idx') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('database', 'crash_test_idx') > 0
ORDER BY score DESC;
 id | content | score 
----+---------+-------
(0 rows)

-- Test search for less common terms
SELECT id, content, content <@> to_tpvector('brown lazy', 'crash_test_idx') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('brown lazy', 'crash_test_idx') > 0
ORDER BY score DESC;
 id | content | score 
----+---------+-------
(0 rows)

-- Simulate recovery by dropping and recreating the index
-- This should trigger the crash recovery mechanism we implemented
DROP INDEX crash_test_idx;
-- Add more data before recreating index to test partial recovery
INSERT INTO crash_test_docs (content, category) VALUES
('recovery testing for database systems', 'tech'),
('the quick recovery process is important', 'tech'),
('brown recovery data should be preserved', 'test');
-- Recreate the index, which should trigger crash recovery
CREATE INDEX crash_test_idx_recovered ON crash_test_docs USING tapir(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  Tapir index build started for relation crash_test_idx_recovered
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 13 documents, avg_length=5.00, text_config='english' (k1=1.20, b=0.75)
-- Verify recovery worked by running same searches
\echo 'Testing post-recovery searches:'
Testing post-recovery searches:
SELECT id, content, content <@> to_tpvector('quick fox', 'crash_test_idx_recovered') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('quick fox', 'crash_test_idx_recovered') > 0
ORDER BY score DESC
LIMIT 5;
 id | content | score 
----+---------+-------
(0 rows)

SELECT id, content, content <@> to_tpvector('database recovery', 'crash_test_idx_recovered') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('database recovery', 'crash_test_idx_recovered') > 0
ORDER BY score DESC;
 id | content | score 
----+---------+-------
(0 rows)

-- Test edge cases
\echo 'Testing edge cases:'
Testing edge cases:
-- Empty result search
SELECT COUNT(*) as should_be_zero
FROM crash_test_docs 
WHERE content <@> to_tpvector('nonexistent terms', 'crash_test_idx_recovered') > 0;
 should_be_zero 
----------------
              0
(1 row)

-- Single term search
SELECT id, content, content <@> to_tpvector('fox', 'crash_test_idx_recovered') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('fox', 'crash_test_idx_recovered') > 0
ORDER BY score DESC;
 id | content | score 
----+---------+-------
(0 rows)

-- Multi-word phrase
SELECT id, content, content <@> to_tpvector('quick brown', 'crash_test_idx_recovered') as score
FROM crash_test_docs 
WHERE content <@> to_tpvector('quick brown', 'crash_test_idx_recovered') > 0
ORDER BY score DESC
LIMIT 3;
 id | content | score 
----+---------+-------
(0 rows)

-- Verify index integrity with some statistics
\echo 'Index statistics verification:'
Index statistics verification:
SELECT 
    COUNT(*) as total_documents,
    COUNT(DISTINCT content) as unique_documents,
    AVG(LENGTH(content)) as avg_content_length
FROM crash_test_docs;
 total_documents | unique_documents | avg_content_length  
-----------------+------------------+---------------------
              13 |               13 | 41.4615384615384615
(1 row)

-- Clean up
DROP TABLE crash_test_docs CASCADE;
