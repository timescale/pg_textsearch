--
-- Test segment flush functionality using explicit tp_spill_memtable()
--
-- Set up extension
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.3-dev: This is prerelease software and should not be used in production.
-- Create a test table
CREATE TABLE segment_test_docs (
    id INT PRIMARY KEY,
    doc TEXT
);
-- Don't use DEBUG messages as they contain non-deterministic addresses
SET client_min_messages = NOTICE;
-- Create BM25 index
CREATE INDEX segment_test_idx ON segment_test_docs
USING bm25 (doc) WITH (text_config='english');
NOTICE:  BM25 index build started for relation segment_test_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert a small set of documents
INSERT INTO segment_test_docs VALUES
    (1, 'search engine algorithms use inverted indices for fast retrieval'),
    (2, 'database systems optimize query performance with indexing'),
    (3, 'full text search requires tokenization and normalization'),
    (4, 'information retrieval uses statistical ranking methods'),
    (5, 'search quality depends on relevance scoring algorithms');
-- Explicitly force memtable to spill to segment
SELECT tp_spill_memtable('segment_test_idx');
