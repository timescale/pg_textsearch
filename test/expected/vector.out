-- Test bm25vector type and operators functionality
-- Load pgtextsearch extension
CREATE EXTENSION IF NOT EXISTS pgtextsearch;
INFO:  pgtextsearch v0.0.1: This is prerelease software and should not be used in production.
-- Enable score logging for testing
SET pgtextsearch.log_scores = true;
SET client_min_messages = NOTICE;
SET enable_seqscan = false;
-- Cleanup any existing state first
DROP TABLE IF EXISTS test_docs CASCADE;
ERROR:  requested DSM segment size does not match size of existing segment
-- Setup test table
CREATE TABLE test_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
ERROR:  relation "test_docs" already exists
INSERT INTO test_docs (content) VALUES
    ('the quick brown fox'),
    ('jumped over the lazy dog'),
    ('sphinx of black quartz'),
    ('hello world example'),
    ('postgresql full text search');
-- Create pgtextsearch index
CREATE INDEX docs_vector_idx ON test_docs USING bm25(content) WITH (text_config='english');
NOTICE:  Tapir index build started for relation docs_vector_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
ERROR:  too many dynamic shared memory segments
-- Test bm25vector I/O functions
-- Test input/output with index name format
SELECT 'docs_vector_idx:{hello:2,world:1}'::bm25vector;
            bm25vector             
-----------------------------------
 docs_vector_idx:{hello:2,world:1}
(1 row)

SELECT 'docs_vector_idx:{}'::bm25vector;
     bm25vector     
--------------------
 docs_vector_idx:{}
(1 row)

-- Test to_bm25vector function
SELECT to_bm25vector('hello world', 'docs_vector_idx');
ERROR:  index "docs_vector_idx" not found
SELECT to_bm25vector('postgresql search', 'docs_vector_idx');
ERROR:  index "docs_vector_idx" not found
-- Test to_bm25vector edge cases
SELECT to_bm25vector('', 'docs_vector_idx');  -- empty text
ERROR:  index "docs_vector_idx" not found
SELECT to_bm25vector('hello, world! How are you? I''m fine.', 'docs_vector_idx');  -- punctuation
ERROR:  index "docs_vector_idx" not found
SELECT to_bm25vector('Testing 123 with numbers and text', 'docs_vector_idx');  -- numbers
ERROR:  index "docs_vector_idx" not found
-- Test that different queries create different vectors
SELECT to_bm25vector('hello', 'docs_vector_idx') = to_bm25vector('world', 'docs_vector_idx');
ERROR:  index "docs_vector_idx" not found
-- Test error cases (bm25vector <@> bm25vector operator removed for consistency)
-- Test nonexistent index error
\set VERBOSITY terse
\set ON_ERROR_STOP off
SELECT to_bm25vector('test text', 'nonexistent_index');
ERROR:  index "nonexistent_index" not found
\set ON_ERROR_STOP on
\set VERBOSITY default
-- Test pgtextsearch scoring using standalone text <@> bm25query operations
SELECT
    content,
    ROUND((content <@> to_bm25query('hello world', 'docs_vector_idx'))::numeric, 4) as score
FROM test_docs
ORDER BY score;
ERROR:  index "docs_vector_idx" not found
