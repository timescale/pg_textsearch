-- Test case: document_length_normalization
-- Generated BM25 test with 3 documents and 4 queries
CREATE EXTENSION IF NOT EXISTS tapir;
SET tapir.log_scores = true;
SET enable_seqscan = off;
-- Create test table
CREATE TABLE document_length_normalization_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO document_length_normalization_docs (content) VALUES ('short doc');
INSERT INTO document_length_normalization_docs (content) VALUES ('this is a medium length document with more words');
INSERT INTO document_length_normalization_docs (content) VALUES ('this is a very long document that contains many words and should demonstrate how BM25 normalizes scores based on document length to avoid bias toward shorter documents');
-- Create Tapir index
CREATE INDEX document_length_normalization_idx ON document_length_normalization_docs USING tapir(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  Tapir index build started for relation document_length_normalization_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 3 documents, avg_length=7.67, text_config='english' (k1=1.20, b=0.75)
-- Test query 1: 'document'
SELECT id, content, ROUND((content <@> to_tpquery('document', 'document_length_normalization_idx'))::numeric, 4) as score
FROM document_length_normalization_docs
ORDER BY content <@> to_tpquery('document', 'document_length_normalization_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,3), BM25_score=-0.1456
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.1453
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,1), BM25_score=-0.0000
 id |                                                                                 content                                                                                 |  score  
----+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------
  3 | this is a very long document that contains many words and should demonstrate how BM25 normalizes scores based on document length to avoid bias toward shorter documents | -0.1456
  2 | this is a medium length document with more words                                                                                                                        | -0.1453
  1 | short doc                                                                                                                                                               |  0.0000
(3 rows)

-- Test query 2: 'length'
SELECT id, content, ROUND((content <@> to_tpquery('length', 'document_length_normalization_idx'))::numeric, 4) as score
FROM document_length_normalization_docs
ORDER BY content <@> to_tpquery('length', 'document_length_normalization_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,2), BM25_score=-0.1453
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,3), BM25_score=-0.0780
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,1), BM25_score=-0.0000
 id |                                                                                 content                                                                                 |  score  
----+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------
  2 | this is a medium length document with more words                                                                                                                        | -0.1453
  3 | this is a very long document that contains many words and should demonstrate how BM25 normalizes scores based on document length to avoid bias toward shorter documents | -0.0780
  1 | short doc                                                                                                                                                               |  0.0000
(3 rows)

-- Test query 3: 'short'
SELECT id, content, ROUND((content <@> to_tpquery('short', 'document_length_normalization_idx'))::numeric, 4) as score
FROM document_length_normalization_docs
ORDER BY content <@> to_tpquery('short', 'document_length_normalization_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,1), BM25_score=-0.7322
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.0000
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,3), BM25_score=-0.0000
 id |                                                                                 content                                                                                 |  score  
----+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------
  1 | short doc                                                                                                                                                               | -0.7322
  2 | this is a medium length document with more words                                                                                                                        |  0.0000
  3 | this is a very long document that contains many words and should demonstrate how BM25 normalizes scores based on document length to avoid bias toward shorter documents |  0.0000
(3 rows)

-- Test query 4: 'words'
SELECT id, content, ROUND((content <@> to_tpquery('words', 'document_length_normalization_idx'))::numeric, 4) as score
FROM document_length_normalization_docs
ORDER BY content <@> to_tpquery('words', 'document_length_normalization_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,2), BM25_score=-0.1453
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,3), BM25_score=-0.0780
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,1), BM25_score=-0.0000
 id |                                                                                 content                                                                                 |  score  
----+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------
  2 | this is a medium length document with more words                                                                                                                        | -0.1453
  3 | this is a very long document that contains many words and should demonstrate how BM25 normalizes scores based on document length to avoid bias toward shorter documents | -0.0780
  1 | short doc                                                                                                                                                               |  0.0000
(3 rows)

-- Cleanup
DROP TABLE document_length_normalization_docs CASCADE;
DROP EXTENSION tapir CASCADE;
