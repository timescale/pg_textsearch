-- Test case: epsilon_handling
-- Generated BM25 test with 5 documents and 4 queries
CREATE EXTENSION IF NOT EXISTS tapir;
SET tapir.log_scores = true;
SET enable_seqscan = off;
-- Create test table
CREATE TABLE epsilon_handling_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO epsilon_handling_docs (content) VALUES ('apple banana cherry');
INSERT INTO epsilon_handling_docs (content) VALUES ('apple banana');
INSERT INTO epsilon_handling_docs (content) VALUES ('cherry');
INSERT INTO epsilon_handling_docs (content) VALUES ('banana');
INSERT INTO epsilon_handling_docs (content) VALUES ('apple cherry banana');
-- Create Tapir index
CREATE INDEX epsilon_handling_idx ON epsilon_handling_docs USING tapir(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  Tapir index build started for relation epsilon_handling_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 5 documents, avg_length=2.00, text_config='english' (k1=1.20, b=0.75)
-- Test query 1: 'apple'
SELECT id, content, ROUND((content <@> to_tpquery('apple', 'epsilon_handling_idx'))::numeric, 4) as score
FROM epsilon_handling_docs
ORDER BY content <@> to_tpquery('apple', 'epsilon_handling_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,2), BM25_score=-0.0625
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,1), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,5), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=3, tid=(0,3), BM25_score=-0.0000
NOTICE:  Tapir index scan: doc_pos=4, tid=(0,4), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  2 | apple banana        | -0.0625
  1 | apple banana cherry | -0.0519
  5 | apple cherry banana | -0.0519
  3 | cherry              |  0.0000
  4 | banana              |  0.0000
(5 rows)

-- Test query 2: 'banana'
SELECT id, content, ROUND((content <@> to_tpquery('banana', 'epsilon_handling_idx'))::numeric, 4) as score
FROM epsilon_handling_docs
ORDER BY content <@> to_tpquery('banana', 'epsilon_handling_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,4), BM25_score=-0.0786
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.0625
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,1), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=3, tid=(0,5), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=4, tid=(0,3), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  4 | banana              | -0.0786
  2 | apple banana        | -0.0625
  1 | apple banana cherry | -0.0519
  5 | apple cherry banana | -0.0519
  3 | cherry              |  0.0000
(5 rows)

-- Test query 3: 'cherry'
SELECT id, content, ROUND((content <@> to_tpquery('cherry', 'epsilon_handling_idx'))::numeric, 4) as score
FROM epsilon_handling_docs
ORDER BY content <@> to_tpquery('cherry', 'epsilon_handling_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,3), BM25_score=-0.0786
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,1), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,5), BM25_score=-0.0519
NOTICE:  Tapir index scan: doc_pos=3, tid=(0,2), BM25_score=-0.0000
NOTICE:  Tapir index scan: doc_pos=4, tid=(0,4), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  3 | cherry              | -0.0786
  1 | apple banana cherry | -0.0519
  5 | apple cherry banana | -0.0519
  2 | apple banana        |  0.0000
  4 | banana              |  0.0000
(5 rows)

-- Test query 4: 'apple banana cherry'
SELECT id, content, ROUND((content <@> to_tpquery('apple banana cherry', 'epsilon_handling_idx'))::numeric, 4) as score
FROM epsilon_handling_docs
ORDER BY content <@> to_tpquery('apple banana cherry', 'epsilon_handling_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,1), BM25_score=-0.1557
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,5), BM25_score=-0.1557
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,2), BM25_score=-0.1250
NOTICE:  Tapir index scan: doc_pos=3, tid=(0,3), BM25_score=-0.0786
NOTICE:  Tapir index scan: doc_pos=4, tid=(0,4), BM25_score=-0.0786
 id |       content       |  score  
----+---------------------+---------
  1 | apple banana cherry | -0.1557
  5 | apple cherry banana | -0.1557
  2 | apple banana        | -0.1250
  3 | cherry              | -0.0786
  4 | banana              | -0.0786
(5 rows)

-- Cleanup
DROP TABLE epsilon_handling_docs CASCADE;
DROP EXTENSION tapir CASCADE;
