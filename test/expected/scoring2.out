-- Test case: scoring2
-- Generated BM25 test with 5 documents and 4 queries
-- Testing both bulk build and incremental build modes
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.5-dev: This is prerelease software and should not be used in production.
INFO:  This release contains breaking changes in the bm25 index structure and will require existing indexes to be rebuilt.
\set ECHO none
SET pg_textsearch.log_scores = true;
SET enable_seqscan = off;
-- MODE 1: Bulk build (insert data, then create index)
CREATE TABLE scoring2_bulk (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO scoring2_bulk (content) VALUES ('hello world');
INSERT INTO scoring2_bulk (content) VALUES ('goodbye world');
INSERT INTO scoring2_bulk (content) VALUES ('hello goodbye');
INSERT INTO scoring2_bulk (content) VALUES ('world domination');
INSERT INTO scoring2_bulk (content) VALUES ('hello');
-- Create index after data insertion (bulk build)
CREATE INDEX scoring2_bulk_idx ON scoring2_bulk USING bm25(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  BM25 index build started for relation scoring2_bulk_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=1.80, text_config='english' (k1=1.20, b=0.75)
-- Bulk mode query 1: 'hello'
SELECT id, content, ROUND((content <@> to_bm25query('hello', 'scoring2_bulk_idx'))::numeric, 4) as score
FROM scoring2_bulk
ORDER BY content <@> to_bm25query('hello', 'scoring2_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=-0.6588
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  5 | hello            | -0.6588
  1 | hello world      | -0.5156
  3 | hello goodbye    | -0.5156
  2 | goodbye world    |  0.0000
  4 | world domination |  0.0000
(5 rows)

-- Validate BM25 scoring for 'hello'
SELECT validate_bm25_scoring('scoring2_bulk', 'content', 'scoring2_bulk_idx', 'hello', 'english', 1.2, 0.75) as hello_bulk_valid;
 hello_bulk_valid 
------------------
 t
(1 row)

-- Bulk mode query 2: 'world'
SELECT id, content, ROUND((content <@> to_bm25query('world', 'scoring2_bulk_idx'))::numeric, 4) as score
FROM scoring2_bulk
ORDER BY content <@> to_bm25query('world', 'scoring2_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  1 | hello world      | -0.5156
  2 | goodbye world    | -0.5156
  4 | world domination | -0.5156
  3 | hello goodbye    |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'world'
SELECT validate_bm25_scoring('scoring2_bulk', 'content', 'scoring2_bulk_idx', 'world', 'english', 1.2, 0.75) as world_bulk_valid;
 world_bulk_valid 
------------------
 t
(1 row)

-- Bulk mode query 3: 'goodbye'
SELECT id, content, ROUND((content <@> to_bm25query('goodbye', 'scoring2_bulk_idx'))::numeric, 4) as score
FROM scoring2_bulk
ORDER BY content <@> to_bm25query('goodbye', 'scoring2_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.8374
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.8374
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  2 | goodbye world    | -0.8374
  3 | hello goodbye    | -0.8374
  1 | hello world      |  0.0000
  4 | world domination |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'goodbye'
SELECT validate_bm25_scoring('scoring2_bulk', 'content', 'scoring2_bulk_idx', 'goodbye', 'english', 1.2, 0.75) as goodbye_bulk_valid;
 goodbye_bulk_valid 
--------------------
 t
(1 row)

-- Bulk mode query 4: 'domination'
SELECT id, content, ROUND((content <@> to_bm25query('domination', 'scoring2_bulk_idx'))::numeric, 4) as score
FROM scoring2_bulk
ORDER BY content <@> to_bm25query('domination', 'scoring2_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=-1.3260
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  4 | world domination | -1.3260
  1 | hello world      |  0.0000
  2 | goodbye world    |  0.0000
  3 | hello goodbye    |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'domination'
SELECT validate_bm25_scoring('scoring2_bulk', 'content', 'scoring2_bulk_idx', 'domination', 'english', 1.2, 0.75) as domination_bulk_valid;
 domination_bulk_valid 
-----------------------
 t
(1 row)

-- MODE 2: Incremental build (create index, then insert data)
CREATE TABLE scoring2_incr (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Create index before data insertion (incremental build)
CREATE INDEX scoring2_incr_idx ON scoring2_incr USING bm25(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  BM25 index build started for relation scoring2_incr_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert test documents incrementally
INSERT INTO scoring2_incr (content) VALUES ('hello world');
INSERT INTO scoring2_incr (content) VALUES ('goodbye world');
INSERT INTO scoring2_incr (content) VALUES ('hello goodbye');
INSERT INTO scoring2_incr (content) VALUES ('world domination');
INSERT INTO scoring2_incr (content) VALUES ('hello');
-- Incremental mode query 1: 'hello'
SELECT id, content, ROUND((content <@> to_bm25query('hello', 'scoring2_incr_idx'))::numeric, 4) as score
FROM scoring2_incr
ORDER BY content <@> to_bm25query('hello', 'scoring2_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=-0.6588
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  5 | hello            | -0.6588
  1 | hello world      | -0.5156
  3 | hello goodbye    | -0.5156
  2 | goodbye world    |  0.0000
  4 | world domination |  0.0000
(5 rows)

-- Validate BM25 scoring for 'hello' (incremental)
SELECT validate_bm25_scoring('scoring2_incr', 'content', 'scoring2_incr_idx', 'hello', 'english', 1.2, 0.75) as hello_incr_valid;
 hello_incr_valid 
------------------
 t
(1 row)

-- Incremental mode query 2: 'world'
SELECT id, content, ROUND((content <@> to_bm25query('world', 'scoring2_incr_idx'))::numeric, 4) as score
FROM scoring2_incr
ORDER BY content <@> to_bm25query('world', 'scoring2_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=-0.5156
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  1 | hello world      | -0.5156
  2 | goodbye world    | -0.5156
  4 | world domination | -0.5156
  3 | hello goodbye    |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'world' (incremental)
SELECT validate_bm25_scoring('scoring2_incr', 'content', 'scoring2_incr_idx', 'world', 'english', 1.2, 0.75) as world_incr_valid;
 world_incr_valid 
------------------
 t
(1 row)

-- Incremental mode query 3: 'goodbye'
SELECT id, content, ROUND((content <@> to_bm25query('goodbye', 'scoring2_incr_idx'))::numeric, 4) as score
FROM scoring2_incr
ORDER BY content <@> to_bm25query('goodbye', 'scoring2_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.8374
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.8374
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  2 | goodbye world    | -0.8374
  3 | hello goodbye    | -0.8374
  1 | hello world      |  0.0000
  4 | world domination |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'goodbye' (incremental)
SELECT validate_bm25_scoring('scoring2_incr', 'content', 'scoring2_incr_idx', 'goodbye', 'english', 1.2, 0.75) as goodbye_incr_valid;
 goodbye_incr_valid 
--------------------
 t
(1 row)

-- Incremental mode query 4: 'domination'
SELECT id, content, ROUND((content <@> to_bm25query('domination', 'scoring2_incr_idx'))::numeric, 4) as score
FROM scoring2_incr
ORDER BY content <@> to_bm25query('domination', 'scoring2_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=-1.3260
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
 id |     content      |  score  
----+------------------+---------
  4 | world domination | -1.3260
  1 | hello world      |  0.0000
  2 | goodbye world    |  0.0000
  3 | hello goodbye    |  0.0000
  5 | hello            |  0.0000
(5 rows)

-- Validate BM25 scoring for 'domination' (incremental)
SELECT validate_bm25_scoring('scoring2_incr', 'content', 'scoring2_incr_idx', 'domination', 'english', 1.2, 0.75) as domination_incr_valid;
 domination_incr_valid 
-----------------------
 t
(1 row)

-- Cleanup
DROP TABLE scoring2_bulk CASCADE;
DROP TABLE scoring2_incr CASCADE;
DROP EXTENSION pg_textsearch CASCADE;
