-- This test demonstrates top-k tapir query patterns for efficient text search
-- Load tapir extension
CREATE EXTENSION IF NOT EXISTS tapir;
NOTICE:  extension "tapir" already exists, skipping
-- Setup test data with realistic documents
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    category TEXT
);
INSERT INTO articles (title, content, category) VALUES 
    ('Introduction to Databases', 'postgresql database management system with advanced indexing capabilities for fast query processing', 'technology'),
    ('Machine Learning Fundamentals', 'machine learning algorithms and artificial intelligence techniques for data analysis and prediction', 'technology'),
    ('Text Search Algorithms', 'full text search with tapir ranking and relevance scoring for information retrieval systems', 'technology'),
    ('Information Retrieval', 'information retrieval and search engines using vector space models and term frequency analysis', 'technology'),
    ('Natural Language Processing', 'natural language processing techniques including parsing stemming and semantic analysis', 'technology'),
    ('Database Optimization', 'database indexing and query optimization strategies for improving performance in large datasets', 'technology'),
    ('Document Classification', 'text mining and document classification using machine learning and statistical methods', 'technology'),
    ('Search Engine Design', 'search relevance and ranking algorithms with focus on user experience and result quality', 'technology'),
    ('Distributed Computing', 'distributed systems and scalability challenges in modern cloud computing environments', 'technology'),
    ('Data Mining Techniques', 'data mining algorithms for pattern discovery and knowledge extraction from large databases', 'technology'),
    ('Web Search Evolution', 'evolution of web search from simple keyword matching to semantic understanding', 'history'),
    ('Big Data Analytics', 'big data analytics platforms and tools for processing massive datasets efficiently', 'technology');
-- Create tapir index with text_config
CREATE INDEX articles_tapir_idx ON articles USING tapir(content) WITH (text_config='english');
NOTICE:  Tapir index build started for relation articles_tapir_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 12 documents, avg_length=9.17, text_config='english' (k1=1.20, b=0.75)
-- Disable sequential scans to force index usage
SET enable_seqscan = off;
-- Test 1: Basic text similarity search with LIMIT
EXPLAIN (COSTS OFF) 
SELECT title, content, content <@> to_tpvector('database', 'articles_tapir_idx') as score
FROM articles 
ORDER BY 3
LIMIT 5;
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:{databas:1}'::tpvector)
(3 rows)

SELECT title, content, ROUND((content <@> to_tpvector('database', 'articles_tapir_idx'))::numeric, 4) as score
FROM articles 
ORDER BY 3
LIMIT 5;
            title            |                                               content                                               |  score  
-----------------------------+-----------------------------------------------------------------------------------------------------+---------
 Data Mining Techniques      | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.0060
 Database Optimization       | database indexing and query optimization strategies for improving performance in large datasets     | -1.0060
 Introduction to Databases   | postgresql database management system with advanced indexing capabilities for fast query processing | -0.9627
 Text Search Algorithms      | full text search with tapir ranking and relevance scoring for information retrieval systems         |  0.0000
 Natural Language Processing | natural language processing techniques including parsing stemming and semantic analysis             |  0.0000
(5 rows)

-- Test 2: Multi-term search with ranking
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> to_tpvector('machine learning', 'articles_tapir_idx') as score
FROM articles 
ORDER BY 3
LIMIT 3;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:{learn:1,machin:1}'::tpvector)
(3 rows)

SELECT title, content, ROUND((content <@> to_tpvector('machine learning', 'articles_tapir_idx'))::numeric, 4) as score
FROM articles 
ORDER BY 3
LIMIT 3;
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction | -2.8917
 Document Classification       | text mining and document classification using machine learning and statistical methods              | -2.8917
 Text Search Algorithms        | full text search with tapir ranking and relevance scoring for information retrieval systems         |  0.0000
(3 rows)

-- Test 3: Category-filtered search
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> to_tpvector('search algorithms', 'articles_tapir_idx') as score
FROM articles 
WHERE category = 'technology'
ORDER BY 3
LIMIT 10;
                                      QUERY PLAN                                       
---------------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:{algorithm:1,search:1}'::tpvector)
         Filter: (category = 'technology'::text)
(4 rows)

SELECT title, content, ROUND((content <@> to_tpvector('search algorithms', 'articles_tapir_idx'))::numeric, 4) as score
FROM articles 
WHERE category = 'technology'
ORDER BY 3
LIMIT 10;
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Search Engine Design          | search relevance and ranking algorithms with focus on user experience and result quality            | -1.6468
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction | -1.0060
 Data Mining Techniques        | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.0060
 Text Search Algorithms        | full text search with tapir ranking and relevance scoring for information retrieval systems         | -0.6132
 Information Retrieval         | information retrieval and search engines using vector space models and term frequency analysis      | -0.5879
 Introduction to Databases     | postgresql database management system with advanced indexing capabilities for fast query processing |  0.0000
 Big Data Analytics            | big data analytics platforms and tools for processing massive datasets efficiently                  |  0.0000
 Natural Language Processing   | natural language processing techniques including parsing stemming and semantic analysis             |  0.0000
 Database Optimization         | database indexing and query optimization strategies for improving performance in large datasets     |  0.0000
 Document Classification       | text mining and document classification using machine learning and statistical methods              |  0.0000
(10 rows)

-- Test 4: Find similar articles to a specific one (no index)
SELECT a2.title, a2.content, ROUND((a2.content <@> to_tpvector(a1.content, 'articles_tapir_idx'))::numeric, 4) as score
FROM articles a1, articles a2
WHERE a1.id = 3  -- "Text Search Algorithms" article
  AND a2.id != a1.id
ORDER BY 3
LIMIT 5;
           title           |                                               content                                               |  score  
---------------------------+-----------------------------------------------------------------------------------------------------+---------
 Search Engine Design      | search relevance and ranking algorithms with focus on user experience and result quality            | -3.5324
 Information Retrieval     | information retrieval and search engines using vector space models and term frequency analysis      | -3.2410
 Document Classification   | text mining and document classification using machine learning and statistical methods              | -1.4458
 Distributed Computing     | distributed systems and scalability challenges in modern cloud computing environments               | -1.0534
 Introduction to Databases | postgresql database management system with advanced indexing capabilities for fast query processing | -0.9627
(5 rows)

-- Test 5: Top results with scoring
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> to_tpvector('database optimization', 'articles_tapir_idx') as score
FROM articles 
ORDER BY 3
LIMIT 10;
                                     QUERY PLAN                                     
------------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:{databas:1,optim:1}'::tpvector)
(3 rows)

SELECT title, content, ROUND((content <@> to_tpvector('database optimization', 'articles_tapir_idx'))::numeric, 4) as score
FROM articles 
ORDER BY 3
LIMIT 10;
            title            |                                               content                                               |  score  
-----------------------------+-----------------------------------------------------------------------------------------------------+---------
 Database Optimization       | database indexing and query optimization strategies for improving performance in large datasets     | -3.0582
 Data Mining Techniques      | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.0060
 Introduction to Databases   | postgresql database management system with advanced indexing capabilities for fast query processing | -0.9627
 Information Retrieval       | information retrieval and search engines using vector space models and term frequency analysis      |  0.0000
 Natural Language Processing | natural language processing techniques including parsing stemming and semantic analysis             |  0.0000
 Document Classification     | text mining and document classification using machine learning and statistical methods              |  0.0000
 Search Engine Design        | search relevance and ranking algorithms with focus on user experience and result quality            |  0.0000
 Distributed Computing       | distributed systems and scalability challenges in modern cloud computing environments               |  0.0000
 Web Search Evolution        | evolution of web search from simple keyword matching to semantic understanding                      |  0.0000
 Big Data Analytics          | big data analytics platforms and tools for processing massive datasets efficiently                  |  0.0000
(10 rows)

-- Test 6: Batch search with different queries (no index)
EXPLAIN (COSTS OFF)
WITH search_terms AS (
    SELECT unnest(ARRAY['database', 'machine learning', 'search algorithms', 'text mining']) as term
)
SELECT s.term, a.title, a.content <@> to_tpvector(s.term, 'articles_tapir_idx') as score
FROM search_terms s
CROSS JOIN articles a
ORDER BY s.term, a.content <@> to_tpvector(s.term, 'articles_tapir_idx');
                                                                                                                   QUERY PLAN                                                                                                                    
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Sort
   Sort Key: (unnest('{database,"machine learning","search algorithms","text mining"}'::text[])), ((a.content <@> to_tpvector((unnest('{database,"machine learning","search algorithms","text mining"}'::text[])), 'articles_tapir_idx'::text)))
   ->  Nested Loop
         ->  ProjectSet
               ->  Result
         ->  Materialize
               ->  Seq Scan on articles a
(7 rows)

WITH search_terms AS (
    SELECT unnest(ARRAY['database', 'machine learning', 'search algorithms', 'text mining']) as term
)
SELECT s.term, a.title, ROUND((a.content <@> to_tpvector(s.term, 'articles_tapir_idx'))::numeric, 4) as score
FROM search_terms s
CROSS JOIN articles a
ORDER BY s.term, a.content <@> to_tpvector(s.term, 'articles_tapir_idx');
       term        |             title             |  score  
-------------------+-------------------------------+---------
 database          | Data Mining Techniques        | -1.0060
 database          | Database Optimization         | -1.0060
 database          | Introduction to Databases     | -0.9627
 database          | Information Retrieval         |  0.0000
 database          | Natural Language Processing   |  0.0000
 database          | Document Classification       |  0.0000
 database          | Search Engine Design          |  0.0000
 database          | Distributed Computing         |  0.0000
 database          | Web Search Evolution          |  0.0000
 database          | Big Data Analytics            |  0.0000
 database          | Machine Learning Fundamentals |  0.0000
 database          | Text Search Algorithms        |  0.0000
 machine learning  | Machine Learning Fundamentals | -2.8917
 machine learning  | Document Classification       | -2.8917
 machine learning  | Information Retrieval         |  0.0000
 machine learning  | Natural Language Processing   |  0.0000
 machine learning  | Database Optimization         |  0.0000
 machine learning  | Search Engine Design          |  0.0000
 machine learning  | Distributed Computing         |  0.0000
 machine learning  | Data Mining Techniques        |  0.0000
 machine learning  | Web Search Evolution          |  0.0000
 machine learning  | Introduction to Databases     |  0.0000
 machine learning  | Text Search Algorithms        |  0.0000
 machine learning  | Big Data Analytics            |  0.0000
 search algorithms | Search Engine Design          | -1.6468
 search algorithms | Machine Learning Fundamentals | -1.0060
 search algorithms | Data Mining Techniques        | -1.0060
 search algorithms | Web Search Evolution          | -0.6709
 search algorithms | Text Search Algorithms        | -0.6132
 search algorithms | Information Retrieval         | -0.5879
 search algorithms | Document Classification       |  0.0000
 search algorithms | Introduction to Databases     |  0.0000
 search algorithms | Natural Language Processing   |  0.0000
 search algorithms | Database Optimization         |  0.0000
 search algorithms | Distributed Computing         |  0.0000
 search algorithms | Big Data Analytics            |  0.0000
 text mining       | Document Classification       | -2.8917
 text mining       | Data Mining Techniques        | -1.4458
 text mining       | Text Search Algorithms        | -1.3836
 text mining       | Natural Language Processing   |  0.0000
 text mining       | Database Optimization         |  0.0000
 text mining       | Search Engine Design          |  0.0000
 text mining       | Distributed Computing         |  0.0000
 text mining       | Web Search Evolution          |  0.0000
 text mining       | Introduction to Databases     |  0.0000
 text mining       | Big Data Analytics            |  0.0000
 text mining       | Machine Learning Fundamentals |  0.0000
 text mining       | Information Retrieval         |  0.0000
(48 rows)

-- Cleanup
DROP TABLE articles CASCADE;
