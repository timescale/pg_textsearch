-- Test hash table automatic resizing with many terms
-- This test creates enough unique terms to trigger hash table resize
-- and verifies the system continues to work correctly
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.3.0 installed
-- Enable score logging for testing
SET pg_textsearch.log_scores = true;
-- Create test table
CREATE TABLE manyterms_test (id serial, content text);
-- Create index to initialize hash table with small initial size
CREATE INDEX manyterms_idx ON manyterms_test USING bm25(content) WITH (text_config='english');
NOTICE:  BM25 index build started for relation manyterms_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Add enough unique terms to exceed initial hash table capacity
-- With 64 buckets at 0.75 load factor, >48 unique terms should trigger automatic resize
INSERT INTO manyterms_test (content) VALUES
('alpha'), ('beta'), ('gamma'), ('delta'), ('epsilon'), ('zeta'), ('eta'), ('theta'),
('iota'), ('kappa'), ('lambda'), ('mu'), ('nu'), ('xi'), ('omicron'), ('pi'),
('rho'), ('sigma'), ('tau'), ('upsilon'), ('phi'), ('chi'), ('psi'), ('omega'),
('one'), ('two'), ('three'), ('four'), ('five'), ('six'), ('seven'), ('eight'),
('nine'), ('ten'), ('eleven'), ('twelve'), ('thirteen'), ('fourteen'), ('fifteen'), ('sixteen'),
('seventeen'), ('eighteen'), ('nineteen'), ('twenty'), ('twentyone'), ('twentytwo'), ('twentythree'), ('twentyfour'),
('twentyfive'), ('twentysix'), ('twentyseven'), ('twentyeight'), ('twentynine'), ('thirty'), ('thirtyone'), ('thirtytwo'),
('thirtythree'), ('thirtyfour'), ('thirtyfive'), ('thirtysix'), ('thirtyseven'), ('thirtyeight'), ('thirtynine'), ('forty'),
('fortyone'), ('fortytwo'), ('fortythree'), ('fortyfour'), ('fortyfive'), ('fortysix'), ('fortyseven'), ('fortyeight'),
('fortynine'), ('fifty'), ('fiftyone'), ('fiftytwo'), ('fiftythree'), ('fiftyfour'), ('fiftyfive'), ('fiftysix');
-- Verify we can count all documents successfully (no errors from resize)
SELECT COUNT(*) as total_docs FROM manyterms_test;
 total_docs 
------------
         80
(1 row)

-- Test searching for specific terms works correctly after resize
SELECT id, content FROM manyterms_test WHERE content = 'alpha' ORDER BY id LIMIT 1;
 id | content 
----+---------
  1 | alpha
(1 row)

SELECT id, content FROM manyterms_test WHERE content = 'omega' ORDER BY id LIMIT 1;
 id | content 
----+---------
 24 | omega
(1 row)

-- Test BM25 scoring still works after hash table resize
SELECT id, content, ROUND((content <@> 'fifty')::numeric, 4) as score
FROM manyterms_test
WHERE content = 'fifty'
ORDER BY score
LIMIT 1;
 id | content |  score  
----+---------+---------
 74 | fifty   | -3.9890
(1 row)

-- Clean up
DROP INDEX manyterms_idx;
DROP TABLE manyterms_test;
DROP EXTENSION pg_textsearch CASCADE;
