-- Test memory limit enforcement for pg_textsearch indexes
-- Create extension if not exists
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.4-dev: This is prerelease software and should not be used in production.
-- Create test table
DROP TABLE IF EXISTS memory_test CASCADE;
NOTICE:  table "memory_test" does not exist, skipping
CREATE TABLE memory_test (id serial PRIMARY KEY, content text);
-- Set a very low memory limit (1MB) to trigger the limit
SET pg_textsearch.index_memory_limit = 1;
-- Create an index with the low memory limit
CREATE INDEX idx_memory_test
ON memory_test
USING bm25(content)
WITH (text_config='english');
NOTICE:  BM25 index build started for relation idx_memory_test
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert some documents
INSERT INTO memory_test (content)
VALUES ('This is a test document with some content');
INSERT INTO memory_test (content)
VALUES ('Another document with different words');
-- Try to insert many documents with lots of unique terms to trigger flush
-- With flush enabled, this should succeed but trigger flushes
-- Use fewer documents to keep test time reasonable
BEGIN;
DO $$
DECLARE
    i integer;
    doc text;
BEGIN
    FOR i IN 1..50 LOOP
        -- Generate document with unique terms to increase memory usage
        doc := 'Document number ' || i || ' with unique terms: ';
        -- Add lots of unique words per document
        FOR j IN 1..100 LOOP
            doc := doc || ' term_' || i || '_' || j;
        END LOOP;

        INSERT INTO memory_test (content) VALUES (doc);
    END LOOP;
END $$;
COMMIT;
-- Verify that the index still works after flush
SELECT id, content
FROM memory_test
WHERE content <@> to_bm25query('test', 'idx_memory_test') < -0.001
ORDER BY content <@> to_bm25query('test', 'idx_memory_test')
LIMIT 5;
 id |                  content                  
----+-------------------------------------------
  1 | This is a test document with some content
(1 row)

-- Reset to default memory limit
RESET pg_textsearch.index_memory_limit;
-- Clean up
DROP TABLE memory_test CASCADE;
