-- Test memory limit enforcement for pg_textsearch indexes
-- Create extension if not exists
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.2.0: This is prerelease software and should not be used in production.
INFO:  This release contains breaking changes in the bm25 index structure and will require existing indexes to be rebuilt.
-- Create test table
DROP TABLE IF EXISTS memory_test CASCADE;
NOTICE:  table "memory_test" does not exist, skipping
CREATE TABLE memory_test (id serial PRIMARY KEY, content text);
-- Set a very low memory limit (1MB) to trigger the limit
SET pg_textsearch.index_memory_limit = 1;
-- Suppress auto-spill NOTICE messages during test to avoid non-deterministic output
-- (The exact DSA memory values vary between runs)
SET client_min_messages = WARNING;
-- Create an index with the low memory limit
CREATE INDEX idx_memory_test
ON memory_test
USING bm25(content)
WITH (text_config='english');
-- Insert some documents
INSERT INTO memory_test (content)
VALUES ('This is a test document with some content');
INSERT INTO memory_test (content)
VALUES ('Another document with different words');
-- Try to insert many documents with lots of unique terms to exceed memory
-- With auto-spill, this should succeed by spilling to disk segments
DO $$
DECLARE
    i integer;
    doc text;
BEGIN
    FOR i IN 1..1000 LOOP
        -- Generate document with unique terms to increase memory usage
        doc := 'Document number ' || i || ' with unique terms: ';
        -- Add lots of unique words per document
        FOR j IN 1..100 LOOP
            doc := doc || ' term_' || i || '_' || j;
        END LOOP;

        INSERT INTO memory_test (content) VALUES (doc);
    END LOOP;
END $$;
-- Re-enable notices for verification output
RESET client_min_messages;
-- Verify that all documents were inserted and index works
SELECT COUNT(*) AS total_docs FROM memory_test;
 total_docs 
------------
       1002
(1 row)

-- Search should find documents
SELECT id, left(content, 50) AS content_preview
FROM memory_test
WHERE content <@> 'test' < -0.001
ORDER BY content <@> 'test'
LIMIT 5;
 id |              content_preview              
----+-------------------------------------------
  1 | This is a test document with some content
(1 row)

-- Reset to default memory limit
RESET pg_textsearch.index_memory_limit;
-- Clean up
DROP TABLE memory_test CASCADE;
DROP EXTENSION pg_textsearch CASCADE;
