-- Test CREATE INDEX CONCURRENTLY with bm25 indexes
--
-- NOTE: CREATE INDEX CONCURRENTLY is currently accepted syntactically but
-- has a known bug where documents may be indexed twice during the validation
-- phase. This causes duplicate results in queries. A proper fix requires
-- implementing the ambulkdelete callback to correctly report existing TIDs
-- to the validate_index phase.
--
-- This test verifies the current behavior: CIC completes successfully and
-- the index is marked valid, even though it may have duplicate entries.
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
NOTICE:  extension "pg_textsearch" already exists, skipping
SET enable_seqscan = off;
--------------------------------------------------------------------------------
-- Test 1: Basic CREATE INDEX CONCURRENTLY
--------------------------------------------------------------------------------
CREATE TABLE cic_basic (
    id SERIAL PRIMARY KEY,
    content TEXT
);
INSERT INTO cic_basic (content) VALUES
    ('the quick brown fox jumps over the lazy dog'),
    ('postgresql is a powerful database system'),
    ('full text search with bm25 ranking');
-- Create index concurrently - should complete without error
CREATE INDEX CONCURRENTLY cic_basic_idx ON cic_basic USING bm25(content)
  WITH (text_config='english');
NOTICE:  BM25 index build started for relation cic_basic_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 3 documents, avg_length=5.00, text_config='english' (k1=1.20, b=0.75)
-- Verify index is valid (indisvalid = true)
SELECT indisvalid FROM pg_index WHERE indexrelid = 'cic_basic_idx'::regclass;
 indisvalid 
------------
 t
(1 row)

-- Verify index is used in query plan
EXPLAIN (COSTS OFF) SELECT id FROM cic_basic
WHERE content <@> to_bm25query('database', 'cic_basic_idx') < 0
ORDER BY content <@> to_bm25query('database', 'cic_basic_idx')
LIMIT 3;
                                         QUERY PLAN                                          
---------------------------------------------------------------------------------------------
 Limit
   ->  Index Scan using cic_basic_idx on cic_basic
         Order By: (content <@> 'cic_basic_idx:database'::bm25query)
         Filter: ((content <@> 'cic_basic_idx:database'::bm25query) < '0'::double precision)
(4 rows)

--------------------------------------------------------------------------------
-- Test 2: DROP INDEX CONCURRENTLY
--------------------------------------------------------------------------------
DROP INDEX CONCURRENTLY cic_basic_idx;
-- Verify index is gone
SELECT COUNT(*) FROM pg_indexes WHERE indexname = 'cic_basic_idx';
 count 
-------
     0
(1 row)

--------------------------------------------------------------------------------
-- Test 3: Recreate with regular CREATE INDEX for comparison
--------------------------------------------------------------------------------
CREATE INDEX cic_basic_idx ON cic_basic USING bm25(content)
  WITH (text_config='english');
NOTICE:  BM25 index build started for relation cic_basic_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 3 documents, avg_length=5.00, text_config='english' (k1=1.20, b=0.75)
-- Verify index is valid
SELECT indisvalid FROM pg_index WHERE indexrelid = 'cic_basic_idx'::regclass;
 indisvalid 
------------
 t
(1 row)

-- Query should work and return expected results
SELECT id FROM cic_basic
WHERE content <@> to_bm25query('database', 'cic_basic_idx') < 0
ORDER BY content <@> to_bm25query('database', 'cic_basic_idx');
 id 
----
  2
(1 row)

--------------------------------------------------------------------------------
-- Cleanup
--------------------------------------------------------------------------------
DROP TABLE cic_basic CASCADE;
DROP EXTENSION pg_textsearch CASCADE;
