-- Test compression functionality
-- Tests that compression (now default) produces correct results
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.3.0-dev: This is prerelease software and should not be used in production.
INFO:  This release contains breaking changes in the bm25 index structure and will require existing indexes to be rebuilt.
-- Compression is now on by default
SHOW pg_textsearch.compress_segments;
 pg_textsearch.compress_segments 
---------------------------------
 on
(1 row)

-- Create test table
CREATE TABLE compression_docs (
    id serial PRIMARY KEY,
    content text
);
-- Create BM25 index
CREATE INDEX compression_idx ON compression_docs
    USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation compression_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert enough documents to create multiple blocks (block size is 128)
-- We need at least 128+ docs with the same term to test block compression
INSERT INTO compression_docs (content)
SELECT 'the quick brown fox jumps over lazy dog number ' || i
FROM generate_series(1, 200) AS i;
-- Force segment creation by spilling memtable
SELECT bm25_spill_index('compression_idx');
 bm25_spill_index 
------------------
                2
(1 row)

-- Query should work correctly with compressed segments
SELECT count(*) FROM compression_docs
WHERE content <@> to_bm25query('fox', 'compression_idx') < 0;
 count 
-------
   200
(1 row)

-- Test with multiple query terms
SELECT count(*) FROM compression_docs
WHERE content <@> to_bm25query('quick brown', 'compression_idx') < 0;
 count 
-------
   200
(1 row)

-- Test that scores are reasonable (not corrupted by compression)
-- Scores should be negative (BM25 returns negative for ORDER BY ASC)
SELECT id, content <@> to_bm25query('fox', 'compression_idx') AS score
FROM compression_docs
WHERE content <@> to_bm25query('fox', 'compression_idx') < 0
ORDER BY score
LIMIT 5;
 id |         score          
----+------------------------
  1 | -0.0024906613398343325
  2 | -0.0024906613398343325
  3 | -0.0024906613398343325
  4 | -0.0024906613398343325
  5 | -0.0024906613398343325
(5 rows)

-- Add more documents and test again
INSERT INTO compression_docs (content)
SELECT 'different content with unique words like zephyr ' || i
FROM generate_series(1, 100) AS i;
-- Spill again to create a second segment
SELECT bm25_spill_index('compression_idx');
 bm25_spill_index 
------------------
                5
(1 row)

-- Query across both segments
SELECT count(*) FROM compression_docs
WHERE content <@> to_bm25query('fox', 'compression_idx') < 0;
 count 
-------
   200
(1 row)

-- Query the new content
SELECT count(*) FROM compression_docs
WHERE content <@> to_bm25query('zephyr', 'compression_idx') < 0;
 count 
-------
   100
(1 row)

-- Test with BMW optimization enabled (default)
SET pg_textsearch.enable_bmw = on;
SELECT id FROM compression_docs
WHERE content <@> to_bm25query('fox', 'compression_idx') < 0
ORDER BY content <@> to_bm25query('fox', 'compression_idx')
LIMIT 5;
 id 
----
  1
  2
  3
  4
  5
(5 rows)

-- Test with BMW disabled to exercise different code path
SET pg_textsearch.enable_bmw = off;
SELECT id FROM compression_docs
WHERE content <@> to_bm25query('fox', 'compression_idx') < 0
ORDER BY content <@> to_bm25query('fox', 'compression_idx')
LIMIT 5;
 id 
----
  1
  2
  3
  4
  5
(5 rows)

-- Reset settings
SET pg_textsearch.enable_bmw = on;
-- Clean up
DROP TABLE compression_docs;
-- Test that compression can be disabled
SET pg_textsearch.compress_segments = off;
SHOW pg_textsearch.compress_segments;
 pg_textsearch.compress_segments 
---------------------------------
 off
(1 row)

-- Create another table with compression off
CREATE TABLE uncompressed_docs (
    id serial PRIMARY KEY,
    content text
);
CREATE INDEX uncompressed_idx ON uncompressed_docs
    USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation uncompressed_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
INSERT INTO uncompressed_docs (content)
SELECT 'testing uncompressed segments ' || i
FROM generate_series(1, 150) AS i;
SELECT bm25_spill_index('uncompressed_idx');
 bm25_spill_index 
------------------
                2
(1 row)

-- Should work the same
SELECT count(*) FROM uncompressed_docs
WHERE content <@> to_bm25query('testing', 'uncompressed_idx') < 0;
 count 
-------
   150
(1 row)

-- Clean up
DROP TABLE uncompressed_docs;
