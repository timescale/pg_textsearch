-- Test handling of empty and whitespace-only documents
-- Ensure extension is loaded
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.1: This is prerelease software and should not be used in production.
-- Create test table with various empty/whitespace content
CREATE TABLE empty_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert various empty/whitespace documents
INSERT INTO empty_docs (content) VALUES
    (''),                           -- completely empty
    ('   '),                        -- only spaces
    ('		'),                      -- only tabs
    ('

    '),                             -- only newlines
    ('
  	 '),                         -- mixed whitespace
    (NULL);                         -- NULL content
-- Create index on content
CREATE INDEX empty_docs_idx ON empty_docs
USING bm25 (content)
WITH (text_config = 'english');
NOTICE:  Tapir index build started for relation empty_docs_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
ERROR:  too many dynamic shared memory segments
-- Try searching - should return no results without warnings
SELECT id, content
FROM empty_docs
WHERE content <@> to_bm25query('test', 'empty_docs_idx') < -0.001
ORDER BY content <@> to_bm25query('test', 'empty_docs_idx') DESC
LIMIT 5;
ERROR:  index "empty_docs_idx" not found
-- Add a document with actual content
INSERT INTO empty_docs (content) VALUES ('test document with content');
-- Search again - should find only the document with content
SELECT id, substring(content, 1, 30) as content_preview
FROM empty_docs
WHERE content <@> to_bm25query('test', 'empty_docs_idx') < -0.001
ORDER BY content <@> to_bm25query('test', 'empty_docs_idx') DESC
LIMIT 5;
ERROR:  index "empty_docs_idx" not found
-- Clean up
DROP TABLE empty_docs;
ERROR:  too many dynamic shared memory segments
DROP EXTENSION pg_textsearch;
