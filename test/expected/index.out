-- Test pg_textsearch index access method functionality
-- Load pg_textsearch extension
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.1: This is prerelease software and should not be used in production.
-- Enable score logging for testing
SET pg_textsearch.log_scores = true;
-- Setup test table
CREATE TABLE test_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
INSERT INTO test_docs (content) VALUES
    ('the quick brown fox'),
    ('jumped over the lazy dog'),
    ('sphinx of black quartz'),
    ('hello world example'),
    ('postgresql full text search');
-- Test index creation with different text_config options
CREATE INDEX docs_english_idx ON test_docs USING pg_textsearch(content) WITH (text_config='english');
NOTICE:  Tapir index build started for relation docs_english_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 5 documents, avg_length=3.20, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX docs_simple_idx ON test_docs USING pg_textsearch(content) WITH (text_config='simple', k1=1.5, b=0.8);
NOTICE:  Tapir index build started for relation docs_simple_idx
NOTICE:  Using text search configuration: simple
NOTICE:  Using index options: k1=1.50, b=0.80
NOTICE:  Tapir index build completed: 5 documents, avg_length=4.00, text_config='simple' (k1=1.50, b=0.80)
-- Verify indexes were created
\d+ test_docs
                                                 Table "public.test_docs"
 Column  |  Type   | Collation | Nullable |                Default                | Storage  | Stats target | Description 
---------+---------+-----------+----------+---------------------------------------+----------+--------------+-------------
 id      | integer |           | not null | nextval('test_docs_id_seq'::regclass) | plain    |              | 
 content | text    |           |          |                                       | extended |              | 
Indexes:
    "test_docs_pkey" PRIMARY KEY, btree (id)
    "docs_english_idx" pg_textsearch (content) WITH (text_config=english)
    "docs_simple_idx" pg_textsearch (content) WITH (text_config=simple, k1='1.5', b='0.8')

-- Test basic index operations
INSERT INTO test_docs (content) VALUES ('new document for testing');
-- Test that to_tpvector works with our indexes
SELECT to_tpvector('test document content', 'docs_english_idx');
                  to_tpvector                   
------------------------------------------------
 docs_english_idx:{content:1,document:1,test:1}
(1 row)

SELECT to_tpvector('test document content', 'docs_simple_idx');
                  to_tpvector                  
-----------------------------------------------
 docs_simple_idx:{content:1,document:1,test:1}
(1 row)

-- Test that index options are correctly stored and retrievable
SELECT
    i.relname as index_name,
    CASE
        WHEN i.reloptions IS NOT NULL THEN 'has_options'
        ELSE 'no_options'
    END as options_status
FROM pg_class i
WHERE i.relname IN ('docs_english_idx', 'docs_simple_idx')
ORDER BY i.relname;
    index_name    | options_status 
------------------+----------------
 docs_english_idx | has_options
 docs_simple_idx  | has_options
(2 rows)

-- Test vectorization with both indexes
SELECT
    'docs_english_idx' as index_name,
    to_tpvector('postgresql database system', 'docs_english_idx') as vector;
    index_name    |                       vector                       
------------------+----------------------------------------------------
 docs_english_idx | docs_english_idx:{databas:1,postgresql:1,system:1}
(1 row)

SELECT
    'docs_simple_idx' as index_name,
    to_tpvector('postgresql database system', 'docs_simple_idx') as vector;
   index_name    |                       vector                       
-----------------+----------------------------------------------------
 docs_simple_idx | docs_simple_idx:{database:1,postgresql:1,system:1}
(1 row)

-- Cleanup
DROP INDEX docs_english_idx;
DROP INDEX docs_simple_idx;
DROP TABLE test_docs;
DROP EXTENSION pg_textsearch CASCADE;
