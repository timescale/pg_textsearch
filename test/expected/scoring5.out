-- Test case: manual_debug
-- Generated BM25 test with 3 documents and 4 queries
CREATE EXTENSION IF NOT EXISTS tapir;
SET tapir.log_scores = true;
SET enable_seqscan = off;
-- Create test table
CREATE TABLE manual_debug_docs (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO manual_debug_docs (content) VALUES ('hello world');
INSERT INTO manual_debug_docs (content) VALUES ('goodbye cruel world');
INSERT INTO manual_debug_docs (content) VALUES ('goodbye nerds');
-- Create Tapir index
CREATE INDEX manual_debug_idx ON manual_debug_docs USING tapir(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  Tapir index build started for relation manual_debug_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  Tapir index build completed: 3 documents, avg_length=2.33, text_config='english' (k1=1.20, b=0.75)
-- Test query 1: 'hello'
SELECT id, content, ROUND((content <@> to_tpquery('hello', 'manual_debug_idx'))::numeric, 4) as score
FROM manual_debug_docs
ORDER BY content <@> to_tpquery('hello', 'manual_debug_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,1), BM25_score=-0.5425
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.0000
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,3), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -0.5425
  2 | goodbye cruel world |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Test query 2: 'cruel'
SELECT id, content, ROUND((content <@> to_tpquery('cruel', 'manual_debug_idx'))::numeric, 4) as score
FROM manual_debug_docs
ORDER BY content <@> to_tpquery('cruel', 'manual_debug_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,2), BM25_score=-0.4574
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,1), BM25_score=-0.0000
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,3), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  2 | goodbye cruel world | -0.4574
  1 | hello world         |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Test query 3: 'world'
SELECT id, content, ROUND((content <@> to_tpquery('world', 'manual_debug_idx'))::numeric, 4) as score
FROM manual_debug_docs
ORDER BY content <@> to_tpquery('world', 'manual_debug_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,1), BM25_score=-0.1079
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.0910
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,3), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -0.1079
  2 | goodbye cruel world | -0.0910
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Test query 4: 'goodbye'
SELECT id, content, ROUND((content <@> to_tpquery('goodbye', 'manual_debug_idx'))::numeric, 4) as score
FROM manual_debug_docs
ORDER BY content <@> to_tpquery('goodbye', 'manual_debug_idx'), id;
NOTICE:  Tapir index scan: doc_pos=0, tid=(0,3), BM25_score=-0.1079
NOTICE:  Tapir index scan: doc_pos=1, tid=(0,2), BM25_score=-0.0910
NOTICE:  Tapir index scan: doc_pos=2, tid=(0,1), BM25_score=-0.0000
 id |       content       |  score  
----+---------------------+---------
  3 | goodbye nerds       | -0.1079
  2 | goodbye cruel world | -0.0910
  1 | hello world         |  0.0000
(3 rows)

-- Cleanup
DROP TABLE manual_debug_docs CASCADE;
DROP EXTENSION tapir CASCADE;
