-- Test case: scoring5
-- Generated BM25 test with 3 documents and 4 queries
-- Testing both bulk build and incremental build modes
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.4-dev: This is prerelease software and should not be used in production.
SET pg_textsearch.log_scores = true;
SET enable_seqscan = off;
-- MODE 1: Bulk build (insert data, then create index)
CREATE TABLE scoring5_bulk (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO scoring5_bulk (content) VALUES ('hello world');
INSERT INTO scoring5_bulk (content) VALUES ('goodbye cruel world');
INSERT INTO scoring5_bulk (content) VALUES ('goodbye nerds');
-- Create index after data insertion (bulk build)
CREATE INDEX scoring5_bulk_idx ON scoring5_bulk USING bm25(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  BM25 index build started for relation scoring5_bulk_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 3 documents, avg_length=2.33, text_config='english' (k1=1.20, b=0.75)
-- Bulk mode query 1: 'hello'
SELECT id, content, ROUND((content <@> to_bm25query('hello', 'scoring5_bulk_idx'))::numeric, 4) as score
FROM scoring5_bulk
ORDER BY content <@> to_bm25query('hello', 'scoring5_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-1.3799
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -1.3799
  2 | goodbye cruel world |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Bulk mode query 2: 'cruel'
SELECT id, content, ROUND((content <@> to_bm25query('cruel', 'scoring5_bulk_idx'))::numeric, 4) as score
FROM scoring5_bulk
ORDER BY content <@> to_bm25query('cruel', 'scoring5_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-1.1633
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  2 | goodbye cruel world | -1.1633
  1 | hello world         |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Bulk mode query 3: 'world'
SELECT id, content, ROUND((content <@> to_bm25query('world', 'scoring5_bulk_idx'))::numeric, 4) as score
FROM scoring5_bulk
ORDER BY content <@> to_bm25query('world', 'scoring5_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.6243
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.5263
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -0.6243
  2 | goodbye cruel world | -0.5263
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Bulk mode query 4: 'goodbye'
SELECT id, content, ROUND((content <@> to_bm25query('goodbye', 'scoring5_bulk_idx'))::numeric, 4) as score
FROM scoring5_bulk
ORDER BY content <@> to_bm25query('goodbye', 'scoring5_bulk_idx'), id;
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.6243
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.5263
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  3 | goodbye nerds       | -0.6243
  2 | goodbye cruel world | -0.5263
  1 | hello world         |  0.0000
(3 rows)

-- MODE 2: Incremental build (create index, then insert data)
CREATE TABLE scoring5_incr (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Create index before data insertion (incremental build)
CREATE INDEX scoring5_incr_idx ON scoring5_incr USING bm25(content)
  WITH (text_config='english', k1=1.2, b=0.75);
NOTICE:  BM25 index build started for relation scoring5_incr_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert test documents incrementally
INSERT INTO scoring5_incr (content) VALUES ('hello world');
INSERT INTO scoring5_incr (content) VALUES ('goodbye cruel world');
INSERT INTO scoring5_incr (content) VALUES ('goodbye nerds');
-- Incremental mode query 1: 'hello'
SELECT id, content, ROUND((content <@> to_bm25query('hello', 'scoring5_incr_idx'))::numeric, 4) as score
FROM scoring5_incr
ORDER BY content <@> to_bm25query('hello', 'scoring5_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.5425
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -0.5425
  2 | goodbye cruel world |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Incremental mode query 2: 'cruel'
SELECT id, content, ROUND((content <@> to_bm25query('cruel', 'scoring5_incr_idx'))::numeric, 4) as score
FROM scoring5_incr
ORDER BY content <@> to_bm25query('cruel', 'scoring5_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.4574
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  2 | goodbye cruel world | -0.4574
  1 | hello world         |  0.0000
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Incremental mode query 3: 'world'
SELECT id, content, ROUND((content <@> to_bm25query('world', 'scoring5_incr_idx'))::numeric, 4) as score
FROM scoring5_incr
ORDER BY content <@> to_bm25query('world', 'scoring5_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-0.0271
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.0229
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  1 | hello world         | -0.0271
  2 | goodbye cruel world | -0.0229
  3 | goodbye nerds       |  0.0000
(3 rows)

-- Incremental mode query 4: 'goodbye'
SELECT id, content, ROUND((content <@> to_bm25query('goodbye', 'scoring5_incr_idx'))::numeric, 4) as score
FROM scoring5_incr
ORDER BY content <@> to_bm25query('goodbye', 'scoring5_incr_idx'), id;
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-0.0271
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-0.0229
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
 id |       content       |  score  
----+---------------------+---------
  3 | goodbye nerds       | -0.0271
  2 | goodbye cruel world | -0.0229
  1 | hello world         |  0.0000
(3 rows)

-- Cleanup
DROP TABLE scoring5_bulk CASCADE;
DROP TABLE scoring5_incr CASCADE;
DROP EXTENSION pg_textsearch CASCADE;
