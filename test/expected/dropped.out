-- Test behavior when using a dropped index name in queries
-- Ensure extension is loaded
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.1: This is prerelease software and should not be used in production.
-- Create test table
CREATE TABLE dropped_idx_test (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO dropped_idx_test (content) VALUES
    ('first test document'),
    ('second test document'),
    ('third test document'),
    ('fourth test document'),
    ('fifth test document');
-- Create index
CREATE INDEX dropped_idx ON dropped_idx_test
USING bm25 (content)
WITH (text_config = 'english');
NOTICE:  Tapir index build started for relation dropped_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
ERROR:  too many dynamic shared memory segments
-- Query should work with index
SELECT COUNT(*) AS with_index
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'dropped_idx') < -0.001;
ERROR:  index "dropped_idx" not found
-- Drop the index
DROP INDEX dropped_idx;
ERROR:  index "dropped_idx" does not exist
-- Query should ERROR when index doesn't exist
SELECT COUNT(*) AS after_drop
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'dropped_idx') < -0.001;
ERROR:  index "dropped_idx" not found
-- Also test with a completely non-existent index name
SELECT COUNT(*) AS nonexistent
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'totally_fake_index') < -0.001;
ERROR:  index "totally_fake_index" not found
-- Clean up
DROP TABLE dropped_idx_test;
ERROR:  too many dynamic shared memory segments
DROP EXTENSION pg_textsearch;
