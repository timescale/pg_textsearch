-- Test behavior when using a dropped index name in queries
-- Ensure extension is loaded
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.4.0-dev installed
-- Create test table
CREATE TABLE dropped_idx_test (
    id SERIAL PRIMARY KEY,
    content TEXT
);
-- Insert test documents
INSERT INTO dropped_idx_test (content) VALUES
    ('first test document'),
    ('second test document'),
    ('third test document'),
    ('fourth test document'),
    ('fifth test document');
-- Create index
CREATE INDEX dropped_idx ON dropped_idx_test
USING bm25 (content)
WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
-- Query should work with index (using explicit index reference)
SELECT COUNT(*) AS with_index
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'dropped_idx') < -0.001;
 with_index 
------------
          5
(1 row)

-- Drop the index
DROP INDEX dropped_idx;
-- Query should ERROR when index doesn't exist
SELECT COUNT(*) AS after_drop
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'dropped_idx') < -0.001;
ERROR:  index "dropped_idx" does not exist
-- Also test with a completely non-existent index name
SELECT COUNT(*) AS nonexistent
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'totally_fake_index') < -0.001;
ERROR:  index "totally_fake_index" does not exist
-- Test registry slot cleanup (issue #83)
-- Create multiple indexes, drop them, then create new ones
-- This verifies that registry slots are properly freed on drop
-- Create 5 indexes
CREATE INDEX dropped_idx_1 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_1
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_2 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_2
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_3 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_3
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_4 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_4
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_5 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_5
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
-- Drop all 5
DROP INDEX dropped_idx_1;
DROP INDEX dropped_idx_2;
DROP INDEX dropped_idx_3;
DROP INDEX dropped_idx_4;
DROP INDEX dropped_idx_5;
-- Create 5 more indexes (should succeed if slots were freed)
CREATE INDEX dropped_idx_6 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_6
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_7 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_7
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_8 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_8
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_9 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_9
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
CREATE INDEX dropped_idx_10 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_10
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
-- Test that the new indexes work
SELECT COUNT(*) AS recycled_slots_work
FROM dropped_idx_test
WHERE content <@> to_bm25query('test', 'dropped_idx_6') < -0.001;
 recycled_slots_work 
---------------------
                   5
(1 row)

-- Also test CASCADE drop (table drop should clean up index slots)
CREATE TABLE cascade_test (id SERIAL, content TEXT);
INSERT INTO cascade_test (content) VALUES ('cascade test doc');
CREATE INDEX cascade_idx ON cascade_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation cascade_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 1 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
-- Drop table should cascade to drop index and free its registry slot
DROP TABLE cascade_test CASCADE;
-- Create another index to verify the cascade-dropped slot was freed
CREATE INDEX dropped_idx_11 ON dropped_idx_test USING bm25 (content) WITH (text_config = 'english');
NOTICE:  BM25 index build started for relation dropped_idx_11
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 5 documents, avg_length=3.00, text_config='english' (k1=1.20, b=0.75)
-- Clean up
DROP TABLE dropped_idx_test;
DROP EXTENSION pg_textsearch;
