-- Test memory limit enforcement for pg_textsearch indexes
-- Create extension if not exists
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.3-dev: This is prerelease software and should not be used in production.
-- Create test table
DROP TABLE IF EXISTS memory_test CASCADE;
NOTICE:  table "memory_test" does not exist, skipping
CREATE TABLE memory_test (id serial PRIMARY KEY, content text);
-- Set a very low memory limit (1MB) to trigger the limit
SET pg_textsearch.index_memory_limit = 1;
-- Create an index with the low memory limit
CREATE INDEX idx_memory_test
ON memory_test
USING bm25(content)
WITH (text_config='english');
NOTICE:  BM25 index build started for relation idx_memory_test
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert some documents
INSERT INTO memory_test (content)
VALUES ('This is a test document with some content');
INSERT INTO memory_test (content)
VALUES ('Another document with different words');
-- Try to insert many documents with lots of unique terms to exceed memory
-- This should eventually trigger the memory limit error
BEGIN;
DO $$
DECLARE
    i integer;
    doc text;
BEGIN
    FOR i IN 1..1000 LOOP
        -- Generate document with unique terms to increase memory usage
        doc := 'Document number ' || i || ' with unique terms: ';
        -- Add lots of unique words per document
        FOR j IN 1..100 LOOP
            doc := doc || ' term_' || i || '_' || j;
        END LOOP;

        INSERT INTO memory_test (content) VALUES (doc);
    END LOOP;
END $$;
ERROR:  pg_textsearch index memory limit exceeded
DETAIL:  Current usage: 1810944 bytes, limit: 1048576 bytes
HINT:  Increase pg_textsearch.index_memory_limit or reduce the amount of data being indexed.
CONTEXT:  SQL statement "INSERT INTO memory_test (content) VALUES (doc)"
PL/pgSQL function inline_code_block line 14 at SQL statement
ROLLBACK;
-- Verify that the index still works after rollback
SELECT id, content
FROM memory_test
WHERE content <@> to_bm25query('test', 'idx_memory_test') < -0.001
ORDER BY content <@> to_bm25query('test', 'idx_memory_test')
LIMIT 5;
 id |                  content                  
----+-------------------------------------------
  1 | This is a test document with some content
(1 row)

-- Reset to default memory limit
RESET pg_textsearch.index_memory_limit;
-- Clean up
DROP TABLE memory_test CASCADE;
