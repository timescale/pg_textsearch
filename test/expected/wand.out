-- BMW Multi-term WAND Traversal Test
--
-- Regression test for doc-ID ordered traversal in multi-term queries.
-- Ensures documents at different block positions across posting lists
-- are correctly scored.
CREATE EXTENSION pg_textsearch;
INFO:  pg_textsearch v0.5.0-dev installed
-- ============================================================
-- TEST: Multi-term documents score correctly across block boundaries
-- ============================================================
CREATE TABLE bmw_bug (id SERIAL PRIMARY KEY, content TEXT);
CREATE INDEX bmw_bug_idx ON bmw_bug USING bm25(content) WITH (text_config='english');
NOTICE:  BM25 index build started for relation bmw_bug_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Insert in order that puts multi-term doc at different block positions:
-- 5 alpha-only docs, then 1 multi-term, then 200 beta-only docs
INSERT INTO bmw_bug (content) SELECT 'alpha only ' || i FROM generate_series(1, 5) i;
INSERT INTO bmw_bug (content) VALUES ('alpha beta both terms here');  -- id=6
INSERT INTO bmw_bug (content) SELECT 'beta only ' || i FROM generate_series(7, 206) i;
-- Spill to segment (creates single segment with all 206 docs)
SELECT bm25_spill_index('bmw_bug_idx');
 bm25_spill_index 
------------------
                2
(1 row)

-- Posting list layout in segment:
-- "alpha": 6 postings (docs 1-5, 6) - fits in single block
-- "beta": 6 postings (doc 6, docs 7-206)
--   - Block 0: docs 6-133
--   - Block 1: docs 134-206
--
-- Doc 6 is the only multi-term document.
-- Get ground truth with exhaustive scoring
SET pg_textsearch.enable_bmw = off;
CREATE TEMP TABLE exhaustive_results AS
SELECT id, content <@> to_bm25query('alpha beta', 'bmw_bug_idx') as score
FROM bmw_bug
WHERE content <@> to_bm25query('alpha beta', 'bmw_bug_idx') < 0
ORDER BY score LIMIT 206;
-- Get BMW results
SET pg_textsearch.enable_bmw = on;
CREATE TEMP TABLE bmw_results AS
SELECT id, content <@> to_bm25query('alpha beta', 'bmw_bug_idx') as score
FROM bmw_bug
WHERE content <@> to_bm25query('alpha beta', 'bmw_bug_idx') < 0
ORDER BY score LIMIT 206;
-- Show both result sets
SELECT 'exhaustive' as path, * FROM exhaustive_results ORDER BY score;
    path    | id  |         score         
------------+-----+-----------------------
 exhaustive |   1 |    -3.464348077774048
 exhaustive |   2 |    -3.464348077774048
 exhaustive |   3 |    -3.464348077774048
 exhaustive |   4 |    -3.464348077774048
 exhaustive |   5 |    -3.464348077774048
 exhaustive |   6 |    -2.899146255105734
 exhaustive |   7 | -0.026956113055348396
 exhaustive |   8 | -0.026956113055348396
 exhaustive |   9 | -0.026956113055348396
 exhaustive |  10 | -0.026956113055348396
 exhaustive |  11 | -0.026956113055348396
 exhaustive |  12 | -0.026956113055348396
 exhaustive |  13 | -0.026956113055348396
 exhaustive |  14 | -0.026956113055348396
 exhaustive |  15 | -0.026956113055348396
 exhaustive |  16 | -0.026956113055348396
 exhaustive |  17 | -0.026956113055348396
 exhaustive |  18 | -0.026956113055348396
 exhaustive |  19 | -0.026956113055348396
 exhaustive |  20 | -0.026956113055348396
 exhaustive |  21 | -0.026956113055348396
 exhaustive |  22 | -0.026956113055348396
 exhaustive |  23 | -0.026956113055348396
 exhaustive |  24 | -0.026956113055348396
 exhaustive |  25 | -0.026956113055348396
 exhaustive |  26 | -0.026956113055348396
 exhaustive |  27 | -0.026956113055348396
 exhaustive |  28 | -0.026956113055348396
 exhaustive |  29 | -0.026956113055348396
 exhaustive |  30 | -0.026956113055348396
 exhaustive |  31 | -0.026956113055348396
 exhaustive |  32 | -0.026956113055348396
 exhaustive |  33 | -0.026956113055348396
 exhaustive |  34 | -0.026956113055348396
 exhaustive |  35 | -0.026956113055348396
 exhaustive |  36 | -0.026956113055348396
 exhaustive |  37 | -0.026956113055348396
 exhaustive |  38 | -0.026956113055348396
 exhaustive |  39 | -0.026956113055348396
 exhaustive |  40 | -0.026956113055348396
 exhaustive |  41 | -0.026956113055348396
 exhaustive |  42 | -0.026956113055348396
 exhaustive |  43 | -0.026956113055348396
 exhaustive |  44 | -0.026956113055348396
 exhaustive |  45 | -0.026956113055348396
 exhaustive |  46 | -0.026956113055348396
 exhaustive |  47 | -0.026956113055348396
 exhaustive |  48 | -0.026956113055348396
 exhaustive |  49 | -0.026956113055348396
 exhaustive |  50 | -0.026956113055348396
 exhaustive |  51 | -0.026956113055348396
 exhaustive |  52 | -0.026956113055348396
 exhaustive |  53 | -0.026956113055348396
 exhaustive |  54 | -0.026956113055348396
 exhaustive |  55 | -0.026956113055348396
 exhaustive |  56 | -0.026956113055348396
 exhaustive |  57 | -0.026956113055348396
 exhaustive |  58 | -0.026956113055348396
 exhaustive |  59 | -0.026956113055348396
 exhaustive |  60 | -0.026956113055348396
 exhaustive |  61 | -0.026956113055348396
 exhaustive |  62 | -0.026956113055348396
 exhaustive |  63 | -0.026956113055348396
 exhaustive |  64 | -0.026956113055348396
 exhaustive |  65 | -0.026956113055348396
 exhaustive |  66 | -0.026956113055348396
 exhaustive |  67 | -0.026956113055348396
 exhaustive |  68 | -0.026956113055348396
 exhaustive |  69 | -0.026956113055348396
 exhaustive |  70 | -0.026956113055348396
 exhaustive |  71 | -0.026956113055348396
 exhaustive |  72 | -0.026956113055348396
 exhaustive |  73 | -0.026956113055348396
 exhaustive |  74 | -0.026956113055348396
 exhaustive |  75 | -0.026956113055348396
 exhaustive |  76 | -0.026956113055348396
 exhaustive |  77 | -0.026956113055348396
 exhaustive |  78 | -0.026956113055348396
 exhaustive |  79 | -0.026956113055348396
 exhaustive |  80 | -0.026956113055348396
 exhaustive |  81 | -0.026956113055348396
 exhaustive |  82 | -0.026956113055348396
 exhaustive |  83 | -0.026956113055348396
 exhaustive |  84 | -0.026956113055348396
 exhaustive |  85 | -0.026956113055348396
 exhaustive |  86 | -0.026956113055348396
 exhaustive |  87 | -0.026956113055348396
 exhaustive |  88 | -0.026956113055348396
 exhaustive |  89 | -0.026956113055348396
 exhaustive |  90 | -0.026956113055348396
 exhaustive |  91 | -0.026956113055348396
 exhaustive |  92 | -0.026956113055348396
 exhaustive |  93 | -0.026956113055348396
 exhaustive |  94 | -0.026956113055348396
 exhaustive |  95 | -0.026956113055348396
 exhaustive |  96 | -0.026956113055348396
 exhaustive |  97 | -0.026956113055348396
 exhaustive |  98 | -0.026956113055348396
 exhaustive |  99 | -0.026956113055348396
 exhaustive | 100 | -0.026956113055348396
 exhaustive | 101 | -0.026956113055348396
 exhaustive | 102 | -0.026956113055348396
 exhaustive | 103 | -0.026956113055348396
 exhaustive | 104 | -0.026956113055348396
 exhaustive | 105 | -0.026956113055348396
 exhaustive | 106 | -0.026956113055348396
 exhaustive | 107 | -0.026956113055348396
 exhaustive | 108 | -0.026956113055348396
 exhaustive | 109 | -0.026956113055348396
 exhaustive | 110 | -0.026956113055348396
 exhaustive | 111 | -0.026956113055348396
 exhaustive | 112 | -0.026956113055348396
 exhaustive | 113 | -0.026956113055348396
 exhaustive | 114 | -0.026956113055348396
 exhaustive | 115 | -0.026956113055348396
 exhaustive | 116 | -0.026956113055348396
 exhaustive | 117 | -0.026956113055348396
 exhaustive | 118 | -0.026956113055348396
 exhaustive | 119 | -0.026956113055348396
 exhaustive | 120 | -0.026956113055348396
 exhaustive | 121 | -0.026956113055348396
 exhaustive | 122 | -0.026956113055348396
 exhaustive | 123 | -0.026956113055348396
 exhaustive | 124 | -0.026956113055348396
 exhaustive | 125 | -0.026956113055348396
 exhaustive | 126 | -0.026956113055348396
 exhaustive | 127 | -0.026956113055348396
 exhaustive | 128 | -0.026956113055348396
 exhaustive | 129 | -0.026956113055348396
 exhaustive | 130 | -0.026956113055348396
 exhaustive | 131 | -0.026956113055348396
 exhaustive | 132 | -0.026956113055348396
 exhaustive | 133 | -0.026956113055348396
 exhaustive | 134 | -0.026956113055348396
 exhaustive | 135 | -0.026956113055348396
 exhaustive | 136 | -0.026956113055348396
 exhaustive | 137 | -0.026956113055348396
 exhaustive | 138 | -0.026956113055348396
 exhaustive | 139 | -0.026956113055348396
 exhaustive | 140 | -0.026956113055348396
 exhaustive | 141 | -0.026956113055348396
 exhaustive | 142 | -0.026956113055348396
 exhaustive | 143 | -0.026956113055348396
 exhaustive | 144 | -0.026956113055348396
 exhaustive | 145 | -0.026956113055348396
 exhaustive | 146 | -0.026956113055348396
 exhaustive | 147 | -0.026956113055348396
 exhaustive | 148 | -0.026956113055348396
 exhaustive | 149 | -0.026956113055348396
 exhaustive | 150 | -0.026956113055348396
 exhaustive | 151 | -0.026956113055348396
 exhaustive | 152 | -0.026956113055348396
 exhaustive | 153 | -0.026956113055348396
 exhaustive | 154 | -0.026956113055348396
 exhaustive | 155 | -0.026956113055348396
 exhaustive | 156 | -0.026956113055348396
 exhaustive | 157 | -0.026956113055348396
 exhaustive | 158 | -0.026956113055348396
 exhaustive | 159 | -0.026956113055348396
 exhaustive | 160 | -0.026956113055348396
 exhaustive | 161 | -0.026956113055348396
 exhaustive | 162 | -0.026956113055348396
 exhaustive | 163 | -0.026956113055348396
 exhaustive | 164 | -0.026956113055348396
 exhaustive | 165 | -0.026956113055348396
 exhaustive | 166 | -0.026956113055348396
 exhaustive | 167 | -0.026956113055348396
 exhaustive | 168 | -0.026956113055348396
 exhaustive | 169 | -0.026956113055348396
 exhaustive | 170 | -0.026956113055348396
 exhaustive | 171 | -0.026956113055348396
 exhaustive | 172 | -0.026956113055348396
 exhaustive | 173 | -0.026956113055348396
 exhaustive | 174 | -0.026956113055348396
 exhaustive | 175 | -0.026956113055348396
 exhaustive | 176 | -0.026956113055348396
 exhaustive | 177 | -0.026956113055348396
 exhaustive | 178 | -0.026956113055348396
 exhaustive | 179 | -0.026956113055348396
 exhaustive | 180 | -0.026956113055348396
 exhaustive | 181 | -0.026956113055348396
 exhaustive | 182 | -0.026956113055348396
 exhaustive | 183 | -0.026956113055348396
 exhaustive | 184 | -0.026956113055348396
 exhaustive | 185 | -0.026956113055348396
 exhaustive | 186 | -0.026956113055348396
 exhaustive | 187 | -0.026956113055348396
 exhaustive | 188 | -0.026956113055348396
 exhaustive | 189 | -0.026956113055348396
 exhaustive | 190 | -0.026956113055348396
 exhaustive | 191 | -0.026956113055348396
 exhaustive | 192 | -0.026956113055348396
 exhaustive | 193 | -0.026956113055348396
 exhaustive | 194 | -0.026956113055348396
 exhaustive | 195 | -0.026956113055348396
 exhaustive | 196 | -0.026956113055348396
 exhaustive | 197 | -0.026956113055348396
 exhaustive | 198 | -0.026956113055348396
 exhaustive | 199 | -0.026956113055348396
 exhaustive | 200 | -0.026956113055348396
 exhaustive | 201 | -0.026956113055348396
 exhaustive | 202 | -0.026956113055348396
 exhaustive | 203 | -0.026956113055348396
 exhaustive | 204 | -0.026956113055348396
 exhaustive | 205 | -0.026956113055348396
 exhaustive | 206 | -0.026956113055348396
(206 rows)

SELECT 'bmw' as path, * FROM bmw_results ORDER BY score;
 path | id  |         score         
------+-----+-----------------------
 bmw  |   1 |    -3.464348077774048
 bmw  |   2 |    -3.464348077774048
 bmw  |   3 |    -3.464348077774048
 bmw  |   4 |    -3.464348077774048
 bmw  |   5 |    -3.464348077774048
 bmw  |   6 |    -2.899146255105734
 bmw  |   7 | -0.026956113055348396
 bmw  |   8 | -0.026956113055348396
 bmw  |   9 | -0.026956113055348396
 bmw  |  10 | -0.026956113055348396
 bmw  |  11 | -0.026956113055348396
 bmw  |  12 | -0.026956113055348396
 bmw  |  13 | -0.026956113055348396
 bmw  |  14 | -0.026956113055348396
 bmw  |  15 | -0.026956113055348396
 bmw  |  16 | -0.026956113055348396
 bmw  |  17 | -0.026956113055348396
 bmw  |  18 | -0.026956113055348396
 bmw  |  19 | -0.026956113055348396
 bmw  |  20 | -0.026956113055348396
 bmw  |  21 | -0.026956113055348396
 bmw  |  22 | -0.026956113055348396
 bmw  |  23 | -0.026956113055348396
 bmw  |  24 | -0.026956113055348396
 bmw  |  25 | -0.026956113055348396
 bmw  |  26 | -0.026956113055348396
 bmw  |  27 | -0.026956113055348396
 bmw  |  28 | -0.026956113055348396
 bmw  |  29 | -0.026956113055348396
 bmw  |  30 | -0.026956113055348396
 bmw  |  31 | -0.026956113055348396
 bmw  |  32 | -0.026956113055348396
 bmw  |  33 | -0.026956113055348396
 bmw  |  34 | -0.026956113055348396
 bmw  |  35 | -0.026956113055348396
 bmw  |  36 | -0.026956113055348396
 bmw  |  37 | -0.026956113055348396
 bmw  |  38 | -0.026956113055348396
 bmw  |  39 | -0.026956113055348396
 bmw  |  40 | -0.026956113055348396
 bmw  |  41 | -0.026956113055348396
 bmw  |  42 | -0.026956113055348396
 bmw  |  43 | -0.026956113055348396
 bmw  |  44 | -0.026956113055348396
 bmw  |  45 | -0.026956113055348396
 bmw  |  46 | -0.026956113055348396
 bmw  |  47 | -0.026956113055348396
 bmw  |  48 | -0.026956113055348396
 bmw  |  49 | -0.026956113055348396
 bmw  |  50 | -0.026956113055348396
 bmw  |  51 | -0.026956113055348396
 bmw  |  52 | -0.026956113055348396
 bmw  |  53 | -0.026956113055348396
 bmw  |  54 | -0.026956113055348396
 bmw  |  55 | -0.026956113055348396
 bmw  |  56 | -0.026956113055348396
 bmw  |  57 | -0.026956113055348396
 bmw  |  58 | -0.026956113055348396
 bmw  |  59 | -0.026956113055348396
 bmw  |  60 | -0.026956113055348396
 bmw  |  61 | -0.026956113055348396
 bmw  |  62 | -0.026956113055348396
 bmw  |  63 | -0.026956113055348396
 bmw  |  64 | -0.026956113055348396
 bmw  |  65 | -0.026956113055348396
 bmw  |  66 | -0.026956113055348396
 bmw  |  67 | -0.026956113055348396
 bmw  |  68 | -0.026956113055348396
 bmw  |  69 | -0.026956113055348396
 bmw  |  70 | -0.026956113055348396
 bmw  |  71 | -0.026956113055348396
 bmw  |  72 | -0.026956113055348396
 bmw  |  73 | -0.026956113055348396
 bmw  |  74 | -0.026956113055348396
 bmw  |  75 | -0.026956113055348396
 bmw  |  76 | -0.026956113055348396
 bmw  |  77 | -0.026956113055348396
 bmw  |  78 | -0.026956113055348396
 bmw  |  79 | -0.026956113055348396
 bmw  |  80 | -0.026956113055348396
 bmw  |  81 | -0.026956113055348396
 bmw  |  82 | -0.026956113055348396
 bmw  |  83 | -0.026956113055348396
 bmw  |  84 | -0.026956113055348396
 bmw  |  85 | -0.026956113055348396
 bmw  |  86 | -0.026956113055348396
 bmw  |  87 | -0.026956113055348396
 bmw  |  88 | -0.026956113055348396
 bmw  |  89 | -0.026956113055348396
 bmw  |  90 | -0.026956113055348396
 bmw  |  91 | -0.026956113055348396
 bmw  |  92 | -0.026956113055348396
 bmw  |  93 | -0.026956113055348396
 bmw  |  94 | -0.026956113055348396
 bmw  |  95 | -0.026956113055348396
 bmw  |  96 | -0.026956113055348396
 bmw  |  97 | -0.026956113055348396
 bmw  |  98 | -0.026956113055348396
 bmw  |  99 | -0.026956113055348396
 bmw  | 100 | -0.026956113055348396
 bmw  | 101 | -0.026956113055348396
 bmw  | 102 | -0.026956113055348396
 bmw  | 103 | -0.026956113055348396
 bmw  | 104 | -0.026956113055348396
 bmw  | 105 | -0.026956113055348396
 bmw  | 106 | -0.026956113055348396
 bmw  | 107 | -0.026956113055348396
 bmw  | 108 | -0.026956113055348396
 bmw  | 109 | -0.026956113055348396
 bmw  | 110 | -0.026956113055348396
 bmw  | 111 | -0.026956113055348396
 bmw  | 112 | -0.026956113055348396
 bmw  | 113 | -0.026956113055348396
 bmw  | 114 | -0.026956113055348396
 bmw  | 115 | -0.026956113055348396
 bmw  | 116 | -0.026956113055348396
 bmw  | 117 | -0.026956113055348396
 bmw  | 118 | -0.026956113055348396
 bmw  | 119 | -0.026956113055348396
 bmw  | 120 | -0.026956113055348396
 bmw  | 121 | -0.026956113055348396
 bmw  | 122 | -0.026956113055348396
 bmw  | 123 | -0.026956113055348396
 bmw  | 124 | -0.026956113055348396
 bmw  | 125 | -0.026956113055348396
 bmw  | 126 | -0.026956113055348396
 bmw  | 127 | -0.026956113055348396
 bmw  | 128 | -0.026956113055348396
 bmw  | 129 | -0.026956113055348396
 bmw  | 130 | -0.026956113055348396
 bmw  | 131 | -0.026956113055348396
 bmw  | 132 | -0.026956113055348396
 bmw  | 133 | -0.026956113055348396
 bmw  | 134 | -0.026956113055348396
 bmw  | 135 | -0.026956113055348396
 bmw  | 136 | -0.026956113055348396
 bmw  | 137 | -0.026956113055348396
 bmw  | 138 | -0.026956113055348396
 bmw  | 139 | -0.026956113055348396
 bmw  | 140 | -0.026956113055348396
 bmw  | 141 | -0.026956113055348396
 bmw  | 142 | -0.026956113055348396
 bmw  | 143 | -0.026956113055348396
 bmw  | 144 | -0.026956113055348396
 bmw  | 145 | -0.026956113055348396
 bmw  | 146 | -0.026956113055348396
 bmw  | 147 | -0.026956113055348396
 bmw  | 148 | -0.026956113055348396
 bmw  | 149 | -0.026956113055348396
 bmw  | 150 | -0.026956113055348396
 bmw  | 151 | -0.026956113055348396
 bmw  | 152 | -0.026956113055348396
 bmw  | 153 | -0.026956113055348396
 bmw  | 154 | -0.026956113055348396
 bmw  | 155 | -0.026956113055348396
 bmw  | 156 | -0.026956113055348396
 bmw  | 157 | -0.026956113055348396
 bmw  | 158 | -0.026956113055348396
 bmw  | 159 | -0.026956113055348396
 bmw  | 160 | -0.026956113055348396
 bmw  | 161 | -0.026956113055348396
 bmw  | 162 | -0.026956113055348396
 bmw  | 163 | -0.026956113055348396
 bmw  | 164 | -0.026956113055348396
 bmw  | 165 | -0.026956113055348396
 bmw  | 166 | -0.026956113055348396
 bmw  | 167 | -0.026956113055348396
 bmw  | 168 | -0.026956113055348396
 bmw  | 169 | -0.026956113055348396
 bmw  | 170 | -0.026956113055348396
 bmw  | 171 | -0.026956113055348396
 bmw  | 172 | -0.026956113055348396
 bmw  | 173 | -0.026956113055348396
 bmw  | 174 | -0.026956113055348396
 bmw  | 175 | -0.026956113055348396
 bmw  | 176 | -0.026956113055348396
 bmw  | 177 | -0.026956113055348396
 bmw  | 178 | -0.026956113055348396
 bmw  | 179 | -0.026956113055348396
 bmw  | 180 | -0.026956113055348396
 bmw  | 181 | -0.026956113055348396
 bmw  | 182 | -0.026956113055348396
 bmw  | 183 | -0.026956113055348396
 bmw  | 184 | -0.026956113055348396
 bmw  | 185 | -0.026956113055348396
 bmw  | 186 | -0.026956113055348396
 bmw  | 187 | -0.026956113055348396
 bmw  | 188 | -0.026956113055348396
 bmw  | 189 | -0.026956113055348396
 bmw  | 190 | -0.026956113055348396
 bmw  | 191 | -0.026956113055348396
 bmw  | 192 | -0.026956113055348396
 bmw  | 193 | -0.026956113055348396
 bmw  | 194 | -0.026956113055348396
 bmw  | 195 | -0.026956113055348396
 bmw  | 196 | -0.026956113055348396
 bmw  | 197 | -0.026956113055348396
 bmw  | 198 | -0.026956113055348396
 bmw  | 199 | -0.026956113055348396
 bmw  | 200 | -0.026956113055348396
 bmw  | 201 | -0.026956113055348396
 bmw  | 202 | -0.026956113055348396
 bmw  | 203 | -0.026956113055348396
 bmw  | 204 | -0.026956113055348396
 bmw  | 205 | -0.026956113055348396
 bmw  | 206 | -0.026956113055348396
(206 rows)

-- TEST 1: Doc 6 should be in exhaustive results (it's the ONLY multi-term doc!)
SELECT 'exhaustive-has-6' as test,
    CASE WHEN 6 IN (SELECT id FROM exhaustive_results)
    THEN 'PASS' ELSE 'FAIL' END as result;
       test       | result 
------------------+--------
 exhaustive-has-6 | PASS
(1 row)

-- TEST 2: Doc 6 should be in BMW results
SELECT 'bmw-has-6' as test,
    CASE WHEN 6 IN (SELECT id FROM bmw_results)
    THEN 'PASS' ELSE 'FAIL' END as result;
   test    | result 
-----------+--------
 bmw-has-6 | PASS
(1 row)

-- TEST 3: Results should match between BMW and exhaustive
SELECT 'results-match' as test,
    CASE WHEN (SELECT COUNT(*) FROM
        (SELECT id FROM exhaustive_results EXCEPT SELECT id FROM bmw_results) x) = 0
    THEN 'PASS' ELSE 'FAIL - RESULTS DIFFER' END as result;
     test      | result 
---------------+--------
 results-match | PASS
(1 row)

-- Show what score doc 6 SHOULD have
SET pg_textsearch.enable_bmw = off;
SELECT 'correct-score-for-6' as info,
    content <@> to_bm25query('alpha beta', 'bmw_bug_idx') as expected_score
FROM bmw_bug WHERE id = 6;
        info         |   expected_score   
---------------------+--------------------
 correct-score-for-6 | -2.899146255105734
(1 row)

DROP TABLE exhaustive_results, bmw_results;
DROP TABLE bmw_bug;
-- ============================================================
-- TEST: 3-term query with multiple blocks (buffer management)
-- ============================================================
-- This tests a bug where zero-copy buffer pins were shared with the
-- reader's cached buffer. When initializing multiple term iterators,
-- reading the dictionary for term N could release the buffer that
-- term N-1's iterator was still using.
CREATE TABLE three_term (id SERIAL PRIMARY KEY, content TEXT);
CREATE INDEX three_term_idx ON three_term USING bm25(content)
    WITH (text_config='english');
NOTICE:  BM25 index build started for relation three_term_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 0 documents, avg_length=0.00, text_config='english' (k1=1.20, b=0.75)
-- Create layout to test multi-term scoring
INSERT INTO three_term (content)
    SELECT 'alpha only ' || i FROM generate_series(1, 3) i;
INSERT INTO three_term (content)
    VALUES ('alpha beta two terms');  -- id=4
INSERT INTO three_term (content)
    SELECT 'beta only ' || i FROM generate_series(5, 7) i;
INSERT INTO three_term (content)
    VALUES ('alpha beta gamma three terms here');  -- id=8
INSERT INTO three_term (content)
    SELECT 'gamma only ' || i FROM generate_series(9, 11) i;
SELECT bm25_spill_index('three_term_idx');
 bm25_spill_index 
------------------
                2
(1 row)

-- Get ground truth with exhaustive scoring
-- Use LIMIT 20 to get all matching docs (only 11 in table)
SET pg_textsearch.enable_bmw = off;
CREATE TEMP TABLE ex_3term AS
SELECT id, content <@> to_bm25query('alpha beta gamma', 'three_term_idx') as score
FROM three_term
WHERE content <@> to_bm25query('alpha beta gamma', 'three_term_idx') < 0
ORDER BY score LIMIT 20;
-- Get BMW results
SET pg_textsearch.enable_bmw = on;
CREATE TEMP TABLE bmw_3term AS
SELECT id, content <@> to_bm25query('alpha beta gamma', 'three_term_idx') as score
FROM three_term
WHERE content <@> to_bm25query('alpha beta gamma', 'three_term_idx') < 0
ORDER BY score LIMIT 20;
-- Show both result sets
SELECT 'exhaustive-3term' as mode, * FROM ex_3term ORDER BY score LIMIT 5;
       mode       | id |        score        
------------------+----+---------------------
 exhaustive-3term |  8 | -1.7842091917991638
 exhaustive-3term |  4 | -1.2407341003417969
 exhaustive-3term | 10 | -1.0612250566482544
 exhaustive-3term | 11 | -1.0612250566482544
 exhaustive-3term |  9 | -1.0612250566482544
(5 rows)

SELECT 'bmw-3term' as mode, * FROM bmw_3term ORDER BY score LIMIT 5;
   mode    | id |        score        
-----------+----+---------------------
 bmw-3term |  8 | -1.7842091917991638
 bmw-3term |  4 | -1.2407341003417969
 bmw-3term | 10 | -1.0612250566482544
 bmw-3term | 11 | -1.0612250566482544
 bmw-3term |  9 | -1.0612250566482544
(5 rows)

-- TEST 5: Doc 8 (3-term doc) should be #1 in both
SELECT '3-term-8-is-top' as test,
    CASE WHEN (SELECT id FROM ex_3term ORDER BY score LIMIT 1) = 8
         AND (SELECT id FROM bmw_3term ORDER BY score LIMIT 1) = 8
    THEN 'PASS' ELSE 'FAIL' END as result;
      test       | result 
-----------------+--------
 3-term-8-is-top | PASS
(1 row)

-- TEST 6: 3-term results should match
SELECT '3-term-results-match' as test,
    CASE WHEN (SELECT COUNT(*) FROM
        (SELECT id FROM ex_3term EXCEPT SELECT id FROM bmw_3term) x) = 0
    THEN 'PASS' ELSE 'FAIL - 3-TERM RESULTS DIFFER' END as result;
         test         | result 
----------------------+--------
 3-term-results-match | PASS
(1 row)

DROP TABLE ex_3term, bmw_3term;
DROP TABLE three_term;
DROP EXTENSION pg_textsearch CASCADE;
