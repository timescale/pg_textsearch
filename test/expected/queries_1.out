-- This test demonstrates top-k pg_textsearch query patterns for efficient text search
-- Load pg_textsearch extension
CREATE EXTENSION IF NOT EXISTS pg_textsearch;
INFO:  pg_textsearch v0.0.4-dev: This is prerelease software and should not be used in production.
-- Enable score logging for testing
SET pg_textsearch.log_scores = true;
SET client_min_messages = NOTICE;
-- Setup test data with realistic documents
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    category TEXT
);
INSERT INTO articles (title, content, category) VALUES
    ('Introduction to Databases', 'postgresql database management system with advanced indexing capabilities for fast query processing', 'technology'),
    ('Machine Learning Fundamentals', 'machine learning algorithms and artificial intelligence techniques for data analysis and prediction', 'technology'),
    ('Text Search Algorithms', 'full text search with tapir ranking and relevance scoring for information retrieval systems', 'technology'),
    ('Information Retrieval', 'information retrieval and search engines using vector space models and term frequency analysis', 'technology'),
    ('Natural Language Processing', 'natural language processing techniques including parsing stemming and semantic analysis', 'technology'),
    ('Database Optimization', 'database indexing and query optimization strategies for improving performance in large datasets', 'technology'),
    ('Document Classification', 'text mining and document classification using machine learning and statistical methods', 'technology'),
    ('Search Engine Design', 'search relevance and ranking algorithms with focus on user experience and result quality', 'technology'),
    ('Distributed Computing', 'distributed systems and scalability challenges in modern cloud computing environments', 'technology'),
    ('Data Mining Techniques', 'data mining algorithms for pattern discovery and knowledge extraction from large databases', 'technology'),
    ('Web Search Evolution', 'evolution of web search from simple keyword matching to semantic understanding', 'history'),
    ('Big Data Analytics', 'big data analytics platforms and tools for processing massive datasets efficiently', 'technology');
-- Create pg_textsearch index with text_config
CREATE INDEX articles_tapir_idx ON articles USING bm25(content) WITH (text_config='english');
NOTICE:  BM25 index build started for relation articles_tapir_idx
NOTICE:  Using text search configuration: english
NOTICE:  Using index options: k1=1.20, b=0.75
NOTICE:  BM25 index build completed: 12 documents, avg_length=9.17, text_config='english' (k1=1.20, b=0.75)
-- Disable sequential scans to force index usage
SET enable_seqscan = off;
-- Test 1: Basic text similarity search with LIMIT
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> 'articles_tapir_idx:database'::bm25query as score
FROM articles
ORDER BY content <@> 'articles_tapir_idx:database'::bm25query
LIMIT 5;
                                QUERY PLAN                                
--------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:database'::bm25query)
(3 rows)

SELECT title, content, ROUND((content <@> 'articles_tapir_idx:database'::bm25query)::numeric, 4) as score
FROM articles
ORDER BY content <@> 'articles_tapir_idx:database'::bm25query
LIMIT 5;
NOTICE:  BM25 index scan: tid=(0,10), BM25_score=-1.3220
NOTICE:  BM25 index scan: tid=(0,6), BM25_score=-1.3220
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-1.2651
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Data Mining Techniques        | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.3220
 Database Optimization         | database indexing and query optimization strategies for improving performance in large datasets     | -1.3220
 Introduction to Databases     | postgresql database management system with advanced indexing capabilities for fast query processing | -1.2651
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction |  0.0000
 Text Search Algorithms        | full text search with tapir ranking and relevance scoring for information retrieval systems         |  0.0000
(5 rows)

-- Test 2: Multi-term search with ranking
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> 'articles_tapir_idx:machine learning'::bm25query as score
FROM articles
ORDER BY content <@> to_bm25query('machine learning', 'articles_tapir_idx')
LIMIT 3;
                                    QUERY PLAN                                    
----------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:machine learning'::bm25query)
(3 rows)

SELECT title, content, ROUND((content <@> 'articles_tapir_idx:machine learning'::bm25query)::numeric, 4) as score
FROM articles
ORDER BY content <@> to_bm25query('machine learning', 'articles_tapir_idx')
LIMIT 3;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-3.3220
NOTICE:  BM25 index scan: tid=(0,7), BM25_score=-3.3220
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction | -3.3220
 Document Classification       | text mining and document classification using machine learning and statistical methods              | -3.3220
 Introduction to Databases     | postgresql database management system with advanced indexing capabilities for fast query processing |  0.0000
(3 rows)

-- Test 3: Category-filtered search
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> 'articles_tapir_idx:search algorithms'::bm25query as score
FROM articles
WHERE category = 'technology'
ORDER BY content <@> to_bm25query('search algorithms', 'articles_tapir_idx')
LIMIT 10;
                                    QUERY PLAN                                     
-----------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:search algorithms'::bm25query)
         Filter: (category = 'technology'::text)
(4 rows)

SELECT title, content, ROUND((content <@> 'articles_tapir_idx:search algorithms'::bm25query)::numeric, 4) as score
FROM articles
WHERE category = 'technology'
ORDER BY content <@> to_bm25query('search algorithms', 'articles_tapir_idx')
LIMIT 10;
NOTICE:  BM25 index scan: tid=(0,8), BM25_score=-2.3908
NOTICE:  BM25 index scan: tid=(0,10), BM25_score=-1.3220
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-1.3220
NOTICE:  BM25 index scan: tid=(0,11), BM25_score=-1.1191
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=-1.0228
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=-0.9806
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,6), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,7), BM25_score=0.0000
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Search Engine Design          | search relevance and ranking algorithms with focus on user experience and result quality            | -2.3908
 Data Mining Techniques        | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.3220
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction | -1.3220
 Text Search Algorithms        | full text search with tapir ranking and relevance scoring for information retrieval systems         | -1.0228
 Information Retrieval         | information retrieval and search engines using vector space models and term frequency analysis      | -0.9806
 Introduction to Databases     | postgresql database management system with advanced indexing capabilities for fast query processing |  0.0000
 Natural Language Processing   | natural language processing techniques including parsing stemming and semantic analysis             |  0.0000
 Database Optimization         | database indexing and query optimization strategies for improving performance in large datasets     |  0.0000
 Document Classification       | text mining and document classification using machine learning and statistical methods              |  0.0000
(9 rows)

-- Test 4: Find similar articles to a specific one (standalone scoring with explicit corpus)
SELECT a2.title, a2.content, ROUND((a2.content <@> to_bm25query(a1.content, 'articles_tapir_idx'))::numeric, 4) as score
FROM articles a1, articles a2
WHERE a1.id = 3  -- "Text Search Algorithms" article
  AND a2.id != a1.id
ORDER BY a2.content <@> to_bm25query(a1.content, 'articles_tapir_idx')
LIMIT 5;
           title           |                                               content                                               |  score  
---------------------------+-----------------------------------------------------------------------------------------------------+---------
 Search Engine Design      | search relevance and ranking algorithms with focus on user experience and result quality            | -4.3908
 Information Retrieval     | information retrieval and search engines using vector space models and term frequency analysis      | -4.0286
 Document Classification   | text mining and document classification using machine learning and statistical methods              | -1.6610
 Distributed Computing     | distributed systems and scalability challenges in modern cloud computing environments               | -1.3843
 Introduction to Databases | postgresql database management system with advanced indexing capabilities for fast query processing | -1.2651
(5 rows)

-- Test 5: Top results with scoring
EXPLAIN (COSTS OFF)
SELECT title, content, content <@> 'articles_tapir_idx:database optimization'::bm25query as score
FROM articles
ORDER BY content <@> to_bm25query('database optimization', 'articles_tapir_idx')
LIMIT 10;
                                      QUERY PLAN                                       
---------------------------------------------------------------------------------------
 Limit
   ->  Index Scan using articles_tapir_idx on articles
         Order By: (content <@> 'articles_tapir_idx:database optimization'::bm25query)
(3 rows)

SELECT title, content, ROUND((content <@> 'articles_tapir_idx:database optimization'::bm25query)::numeric, 4) as score
FROM articles
ORDER BY content <@> to_bm25query('database optimization', 'articles_tapir_idx')
LIMIT 10;
NOTICE:  BM25 index scan: tid=(0,6), BM25_score=-3.4977
NOTICE:  BM25 index scan: tid=(0,10), BM25_score=-1.3220
NOTICE:  BM25 index scan: tid=(0,1), BM25_score=-1.2651
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,3), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,4), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,5), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,7), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,8), BM25_score=0.0000
NOTICE:  BM25 index scan: tid=(0,9), BM25_score=0.0000
             title             |                                               content                                               |  score  
-------------------------------+-----------------------------------------------------------------------------------------------------+---------
 Database Optimization         | database indexing and query optimization strategies for improving performance in large datasets     | -3.4977
 Data Mining Techniques        | data mining algorithms for pattern discovery and knowledge extraction from large databases          | -1.3220
 Introduction to Databases     | postgresql database management system with advanced indexing capabilities for fast query processing | -1.2651
 Machine Learning Fundamentals | machine learning algorithms and artificial intelligence techniques for data analysis and prediction |  0.0000
 Text Search Algorithms        | full text search with tapir ranking and relevance scoring for information retrieval systems         |  0.0000
 Information Retrieval         | information retrieval and search engines using vector space models and term frequency analysis      |  0.0000
 Natural Language Processing   | natural language processing techniques including parsing stemming and semantic analysis             |  0.0000
 Document Classification       | text mining and document classification using machine learning and statistical methods              |  0.0000
 Search Engine Design          | search relevance and ranking algorithms with focus on user experience and result quality            |  0.0000
 Distributed Computing         | distributed systems and scalability challenges in modern cloud computing environments               |  0.0000
(10 rows)

-- Test 6: Batch search with different queries
-- Note: In PG18, queries without index names fail due to eager evaluation
-- This test uses the index name to work correctly
EXPLAIN (COSTS OFF)
WITH search_terms AS (
    SELECT unnest(ARRAY['database', 'machine learning', 'search algorithms', 'text mining']) as term
)
SELECT s.term, a.title, ROUND((a.content <@> to_bm25query(s.term, 'articles_tapir_idx'))::numeric, 4) as score
FROM search_terms s
CROSS JOIN articles a
ORDER BY s.term, a.content <@> to_bm25query(s.term, 'articles_tapir_idx'), a.title;
                                                                                                                        QUERY PLAN                                                                                                                         
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Sort
   Sort Key: (unnest('{database,"machine learning","search algorithms","text mining"}'::text[])), ((a.content <@> to_bm25query((unnest('{database,"machine learning","search algorithms","text mining"}'::text[])), 'articles_tapir_idx'::text))), a.title
   ->  Nested Loop
         ->  ProjectSet
               ->  Result
         ->  Materialize
               ->  Seq Scan on articles a
(7 rows)

-- Test scoring consistency for multi-term query
\echo 'Testing ORDER BY vs standalone scoring for multi-term queries'
Testing ORDER BY vs standalone scoring for multi-term queries
WITH order_by_results AS (
    SELECT id, title,
           ROUND((content <@> 'articles_tapir_idx:machine learning algorithm'::bm25query)::numeric, 6) as order_by_score
    FROM articles
    ORDER BY content <@> to_bm25query('machine learning algorithm', 'articles_tapir_idx')
    LIMIT 2
),
standalone_results AS (
    SELECT id, title,
           ROUND((content <@> 'articles_tapir_idx:machine learning algorithm'::bm25query)::numeric, 6) as standalone_score
    FROM articles
    WHERE id IN (SELECT id FROM order_by_results)
)
SELECT o.id, o.title,
       o.order_by_score,
       s.standalone_score,
       CASE WHEN abs(o.order_by_score - s.standalone_score) < 0.000001
            THEN '✓ CONSISTENT'
            ELSE '✗ INCONSISTENT'
       END as consistency_check
FROM order_by_results o
JOIN standalone_results s ON o.id = s.id
ORDER BY o.id;
NOTICE:  BM25 index scan: tid=(0,2), BM25_score=-4.6440
NOTICE:  BM25 index scan: tid=(0,7), BM25_score=-3.3220
 id |             title             | order_by_score | standalone_score | consistency_check 
----+-------------------------------+----------------+------------------+-------------------
  2 | Machine Learning Fundamentals |      -4.644046 |        -4.644046 | ✓ CONSISTENT
  7 | Document Classification       |      -3.322026 |        -3.322026 | ✓ CONSISTENT
(2 rows)

-- Cleanup
DROP TABLE articles CASCADE;
DROP EXTENSION pg_textsearch CASCADE;
