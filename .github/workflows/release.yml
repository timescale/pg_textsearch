name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [17]

    steps:
    - uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates build-essential bc
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}

    - name: Start PostgreSQL
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        # Create fresh PostgreSQL instance to avoid DSA segment accumulation
        rm -rf tmp_release_check
        mkdir -p tmp_release_check
        initdb -D tmp_release_check/data --auth-local=trust --auth-host=trust
        echo "port = 55433" >> tmp_release_check/data/postgresql.conf
        echo "shared_buffers = 256MB" >> tmp_release_check/data/postgresql.conf
        echo "max_connections = 20" >> tmp_release_check/data/postgresql.conf
        echo "unix_socket_directories = '$PWD/tmp_release_check'" >> tmp_release_check/data/postgresql.conf
        pg_ctl start -D tmp_release_check/data -l tmp_release_check/data/logfile -w
        createdb -h $PWD/tmp_release_check -p 55433 contrib_regression

    - name: Build extension (optimized)
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        make clean
        # Build optimized version for release
        CFLAGS="-O3 -DNDEBUG" make
        sudo make install

    - name: Run full test suite
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        export PGHOST=$PWD/tmp_release_check
        export PGPORT=55433
        # Run regression tests using pg_regress directly
        /usr/lib/postgresql/${{ matrix.pg_version }}/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress \
          --inputdir=test --outputdir=test --dbname=contrib_regression \
          aerodocs basic deletion dropped empty index limits manyterms mixed queries \
          schema scoring1 scoring2 scoring3 scoring4 scoring5 scoring6 strings vector
        # Run concurrency tests directly
        cd test/scripts && TEST_SIZE_MULTIPLIER=3.0 ./concurrency.sh

    - name: Package extension
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        mkdir -p dist/pg${{ matrix.pg_version }}

        # Copy extension files
        cp pg_textsearch.control dist/pg${{ matrix.pg_version }}/
        cp sql/pg_textsearch--0.0.1.sql dist/pg${{ matrix.pg_version }}/

        # Copy built library with version info
        PG_LIB_DIR=$(pg_config --pkglibdir)
        if [ -f "$PG_LIB_DIR/pg_textsearch.so" ]; then
          cp "$PG_LIB_DIR/pg_textsearch.so" dist/pg${{ matrix.pg_version }}/
        elif [ -f "pg_textsearch.dylib" ]; then
          cp pg_textsearch.dylib dist/pg${{ matrix.pg_version }}/
        fi

        # Create README for this version
        cat > dist/pg${{ matrix.pg_version }}/README.txt << 'READMEEOF'
        pg_textsearch PostgreSQL Extension
        PostgreSQL Version: ${{ matrix.pg_version }}
        Built: $(date)
        Commit: ${{ github.sha }}

        Installation:
        1. Copy pg_textsearch.control and pg_textsearch--0.0.1.sql to your PostgreSQL extension directory
        2. Copy the library file to your PostgreSQL library directory
        3. Run: CREATE EXTENSION pg_textsearch;

        For detailed documentation, see: https://github.com/timescale/tapir
        READMEEOF

        # Create tarball
        cd dist
        tar -czf ../pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz pg${{ matrix.pg_version }}/
        cd ..

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}
        path: |
          dist/pg${{ matrix.pg_version }}/
          pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz
        retention-days: 30

    - name: Upload release assets
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz
        asset_name: pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip
