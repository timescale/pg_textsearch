name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual testing

permissions:
  contents: write  # Needed to upload assets to releases
  deployments: write  # Needed for benchmark tracking

jobs:
  # Performance regression check before release
  benchmark-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Install PostgreSQL 17
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates build-essential bc jq
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
            sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | \
            sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-17 postgresql-server-dev-17

    - name: Build extension (optimized)
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        make clean
        CFLAGS="-O3 -DNDEBUG" make
        sudo make install

    - name: Start PostgreSQL
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        rm -rf tmp_bench
        mkdir -p tmp_bench/socket
        initdb -D tmp_bench/data --auth-local=trust --auth-host=trust
        echo "shared_buffers = 256MB" >> tmp_bench/data/postgresql.conf
        echo "max_connections = 20" >> tmp_bench/data/postgresql.conf
        echo "unix_socket_directories = '$PWD/tmp_bench/socket'" >> tmp_bench/data/postgresql.conf
        pg_ctl start -D tmp_bench/data -l tmp_bench/postgres.log -w
        export PGHOST="$PWD/tmp_bench/socket"
        createdb bench_test
        psql -d bench_test -c "CREATE EXTENSION pg_textsearch"
        echo "PGHOST=$PWD/tmp_bench/socket" >> $GITHUB_ENV

    - name: Run Cranfield benchmark
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        export PGDATABASE=bench_test

        cd benchmarks/sql/cranfield
        psql -f 01-load.sql 2>&1 | tee "$GITHUB_WORKSPACE/benchmark_results.txt"
        psql -f 02-queries.sql 2>&1 | tee -a "$GITHUB_WORKSPACE/benchmark_results.txt"

    - name: Extract and format metrics
      run: |
        chmod +x benchmarks/runner/extract_metrics.sh
        chmod +x benchmarks/runner/format_for_action.sh
        ./benchmarks/runner/extract_metrics.sh benchmark_results.txt benchmark_metrics.json
        jq '.dataset = "cranfield"' benchmark_metrics.json > tmp.json && mv tmp.json benchmark_metrics.json
        ./benchmarks/runner/format_for_action.sh benchmark_metrics.json benchmark_action.json

    - name: Check for performance regression
      if: hashFiles('benchmark_action.json') != ''
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: 'Cranfield Benchmarks'
        tool: 'customSmallerIsBetter'
        output-file-path: benchmark_action.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        alert-threshold: '120%'
        fail-on-alert: true
        comment-on-alert: true
        save-data-file: false
        benchmark-data-dir-path: 'benchmarks'

    - name: Cleanup
      if: always()
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        pg_ctl stop -D tmp_bench/data || true
        rm -rf tmp_bench

  build-and-test:
    needs: benchmark-gate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [17, 18]

    steps:
    - uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates build-essential bc
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}

    - name: Start PostgreSQL
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        # Create fresh PostgreSQL instance to avoid DSA segment accumulation
        rm -rf tmp_release_check
        mkdir -p tmp_release_check
        initdb -D tmp_release_check/data --auth-local=trust --auth-host=trust
        echo "port = 55433" >> tmp_release_check/data/postgresql.conf
        echo "shared_buffers = 256MB" >> tmp_release_check/data/postgresql.conf
        echo "max_connections = 20" >> tmp_release_check/data/postgresql.conf
        echo "unix_socket_directories = '$PWD/tmp_release_check'" >> tmp_release_check/data/postgresql.conf
        pg_ctl start -D tmp_release_check/data -l tmp_release_check/data/logfile -w
        createdb -h $PWD/tmp_release_check -p 55433 contrib_regression

    - name: Build extension (optimized)
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        make clean
        # Build optimized version for release
        CFLAGS="-O3 -DNDEBUG" make
        sudo make install

    - name: Run full test suite
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        export PGHOST=$PWD/tmp_release_check
        export PGPORT=55433
        # Run regression tests using pg_regress directly
        /usr/lib/postgresql/${{ matrix.pg_version }}/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress \
          --inputdir=test --outputdir=test --dbname=contrib_regression \
          aerodocs basic deletion vacuum dropped empty implicit index inheritance limits lock \
          manyterms memory merge mixed partitioned queries schema scoring1 scoring2 scoring3 \
          scoring4 scoring5 scoring6 segment strings unsupported updates vector
        # Run concurrency tests directly
        cd test/scripts && TEST_SIZE_MULTIPLIER=3.0 ./concurrency.sh

    - name: Package extension
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        mkdir -p dist/pg${{ matrix.pg_version }}

        # Copy extension files
        cp pg_textsearch.control dist/pg${{ matrix.pg_version }}/
        cp sql/pg_textsearch--*.sql dist/pg${{ matrix.pg_version }}/

        # Copy built library with version info
        PG_LIB_DIR=$(pg_config --pkglibdir)
        if [ -f "$PG_LIB_DIR/pg_textsearch.so" ]; then
          cp "$PG_LIB_DIR/pg_textsearch.so" dist/pg${{ matrix.pg_version }}/
        elif [ -f "pg_textsearch.dylib" ]; then
          cp pg_textsearch.dylib dist/pg${{ matrix.pg_version }}/
        fi

        # Create README for this version
        cat > dist/pg${{ matrix.pg_version }}/README.txt << 'READMEEOF'
        pg_textsearch PostgreSQL Extension
        PostgreSQL Version: ${{ matrix.pg_version }}
        Built: $(date)
        Commit: ${{ github.sha }}

        Installation:
        1. Copy pg_textsearch.control and pg_textsearch--*.sql to your PostgreSQL extension directory
        2. Copy the library file to your PostgreSQL library directory
        3. Run: CREATE EXTENSION pg_textsearch;

        For detailed documentation, see: https://github.com/timescale/pg_textsearch
        READMEEOF

        # Create tarball
        cd dist
        tar -czf ../pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz pg${{ matrix.pg_version }}/
        cd ..

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}
        path: |
          dist/pg${{ matrix.pg_version }}/
          pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz
        retention-days: 30

    - name: Upload release assets
      if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # For tag pushes, create a release first if it doesn't exist
        if [ "${{ github.event_name }}" = "push" ]; then
          # Check if release exists
          if ! gh release view "${{ github.ref_name }}" &>/dev/null; then
            echo "Creating release for tag ${{ github.ref_name }}"
            gh release create "${{ github.ref_name }}" \
              --title "Release ${{ github.ref_name }}" \
              --notes "Release ${{ github.ref_name }}" \
              --draft
          fi
        fi

        # Upload the asset
        echo "Uploading pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz to release ${{ github.ref_name }}"
        gh release upload "${{ github.ref_name }}" \
          "./pg_textsearch-pg${{ matrix.pg_version }}-${{ github.ref_name }}.tar.gz" \
          --clobber
