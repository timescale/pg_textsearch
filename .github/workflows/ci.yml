name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [15, 16, 17]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
    
    - name: Install build dependencies
      run: |
        sudo apt-get install -y build-essential bc
        
    - name: Start PostgreSQL
      run: |
        sudo systemctl start postgresql
        sudo -u postgres createuser -s $USER
        sudo -u postgres createdb $USER
    
    - name: Build extension
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        make clean
        # Build with strict compiler warnings like pgvector
        CFLAGS="-Wall -Wextra -Werror" make
        sudo env "PATH=$PATH" make install
    
    - name: Run regression tests
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        # Verify extension is installed
        echo "Checking if tapir.so is installed..."
        ls -la /usr/lib/postgresql/${{ matrix.pg_version }}/lib/tapir.so
        
        # Run the test setup manually since extension is already installed
        rm -rf tmp_check_shared
        mkdir -p tmp_check_shared
        initdb -D tmp_check_shared/data --auth-local=trust --auth-host=trust
        echo "port = 55433" >> tmp_check_shared/data/postgresql.conf
        echo "shared_preload_libraries = 'tapir'" >> tmp_check_shared/data/postgresql.conf
        echo "log_statement = 'all'" >> tmp_check_shared/data/postgresql.conf
        echo "shared_buffers = 256MB" >> tmp_check_shared/data/postgresql.conf
        echo "max_connections = 20" >> tmp_check_shared/data/postgresql.conf
        echo "unix_socket_directories = '$PWD/tmp_check_shared'" >> tmp_check_shared/data/postgresql.conf
        
        # Try to start PostgreSQL and show logs if it fails
        if ! pg_ctl start -D tmp_check_shared/data -l tmp_check_shared/data/logfile -w; then
          echo "PostgreSQL failed to start. Log contents:"
          cat tmp_check_shared/data/logfile
          exit 1
        fi
        
        createdb -h $PWD/tmp_check_shared -p 55433 contrib_regression
        if ! /usr/lib/postgresql/${{ matrix.pg_version }}/lib/pgxs/src/makefiles/../../src/test/regress/pg_regress --use-existing --host=$PWD/tmp_check_shared --port=55433 --inputdir=test --outputdir=test basic index vector queries aerodocs mixed strings limits --dbname=contrib_regression; then
          echo "Tests failed. Showing regression diffs:"
          if [ -f test/regression.diffs ]; then
            cat test/regression.diffs
          fi
          pg_ctl stop -D tmp_check_shared/data -l tmp_check_shared/data/logfile || true
          rm -rf tmp_check_shared || true
          exit 1
        fi
        pg_ctl stop -D tmp_check_shared/data -l tmp_check_shared/data/logfile
        rm -rf tmp_check_shared
    
    - name: Run shell-based tests
      timeout-minutes: 15
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
        echo "Running concurrency tests..."
        if (cd test/scripts && ./concurrency.sh); then
          echo "✓ Concurrency tests passed"
        else
          echo "✗ Concurrency tests failed"
          exit 1
        fi
        
    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-pg${{ matrix.pg_version }}
        path: |
          test/regression.diffs
          test/regression.out
          test/results/
        retention-days: 7


  build-test-multiple-configs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - { cc: gcc, pg_version: 15 }
          - { cc: gcc, pg_version: 16 }
          - { cc: gcc, pg_version: 17 }
          - { cc: clang, pg_version: 15 }
          - { cc: clang, pg_version: 16 }
          - { cc: clang, pg_version: 17 }
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install PostgreSQL and build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates build-essential bc
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.config.pg_version }} postgresql-server-dev-${{ matrix.config.pg_version }}
        
    - name: Build with ${{ matrix.config.cc }}
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.config.pg_version }}/bin:$PATH"
        export CC=${{ matrix.config.cc }}
        make clean
        # Build with strict warnings to catch issues early
        CFLAGS="-Wall -Wextra -Werror" make
        
  performance-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install PostgreSQL 17
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates build-essential bc
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
        sudo apt-get update
        sudo apt-get install -y postgresql-17 postgresql-server-dev-17
        
    - name: Start PostgreSQL
      run: |
        sudo systemctl start postgresql
        sudo -u postgres createuser -s $USER
        sudo -u postgres createdb $USER
        
    - name: Build and install extension
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        make clean && make && sudo make install
        
    - name: Run performance benchmarks
      timeout-minutes: 20
      run: |
        export PATH="/usr/lib/postgresql/17/bin:$PATH"
        # Run larger concurrency test for performance validation
        echo "Running performance benchmarks..."
        cd test/scripts && TEST_SIZE_MULTIPLIER=5.0 ./concurrency.sh
        
    - name: Upload performance results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: |
          test/tmp_concurrent_test/postgres.log
        retention-days: 7