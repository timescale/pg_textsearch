# Run regression tests under memory sanitizer
name: Sanitizer test
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  name: "Sanitizer"
  PG_SRC_DIR: "pgbuild"
  PG_INSTALL_DIR: "postgresql"
  extra_packages: "clang-15 llvm-15"
  CC: "clang-15"
  CXX: "clang-15"
  CFLAGS: "-g -fsanitize=address,undefined -fno-omit-frame-pointer -Og"
  CXXFLAGS: "-g -fsanitize=address,undefined -fno-omit-frame-pointer -Og"
  LDFLAGS: "-fsanitize=address,undefined"

  # Sanitizer options - create logs directory for better debugging
  ASAN_OPTIONS: "detect_leaks=0 abort_on_error=1 exitcode=27 log_path=${{ github.workspace }}/sanitizer_logs/sanitizer log_exe_name=true"
  UBSAN_OPTIONS: "halt_on_error=1 exitcode=27 print_stacktrace=1 log_path=${{ github.workspace }}/sanitizer_logs/sanitizer log_exe_name=true"

jobs:
  sanitizer:
    name: PostgreSQL 17 Sanitizer ubuntu-22.04
    runs-on: ubuntu-22.04
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flex bison build-essential libssl-dev libreadline-dev systemd-coredump gdb ${{ env.extra_packages }}

    - name: Checkout
      uses: actions/checkout@v4

    - name: Create sanitizer logs directory
      run: mkdir -p ${{ github.workspace }}/sanitizer_logs

    - name: Get date for caching
      id: get-date
      run: echo "date=$(date +\"%d\")" >> $GITHUB_OUTPUT

    - name: Cache PostgreSQL
      id: cache-postgresql
      uses: actions/cache@v4
      with:
        path: ~/${{ env.PG_SRC_DIR }}
        key: "${{ env.name }}-postgresql-17-${{ env.CC }}-${{ steps.get-date.outputs.date }}"

    - name: Build PostgreSQL with sanitizers
      if: steps.cache-postgresql.outputs.cache-hit != 'true'
      run: |
        wget -q -O postgresql.tar.bz2 \
          https://ftp.postgresql.org/pub/source/v17.0/postgresql-17.0.tar.bz2
        mkdir -p ~/$PG_SRC_DIR
        tar --extract --file postgresql.tar.bz2 --directory ~/$PG_SRC_DIR --strip-components 1

        cd ~/$PG_SRC_DIR
        ./configure --prefix=$HOME/$PG_INSTALL_DIR --enable-debug --enable-cassert \
          --with-openssl --without-readline --without-zlib --without-libxml
        make -j$(nproc)

    - name: Install PostgreSQL
      run: |
        cd ~/$PG_SRC_DIR
        make install
        ~/$PG_INSTALL_DIR/bin/pg_config --version

    - name: Build and install Tapir
      run: |
        export PATH="$HOME/$PG_INSTALL_DIR/bin:$PATH"
        make clean
        make
        make install

    - name: Run regression tests
      run: |
        export PATH="$HOME/$PG_INSTALL_DIR/bin:$PATH"

        # Set up test database
        rm -rf tmp_sanitizer_test
        mkdir -p tmp_sanitizer_test
        initdb -D tmp_sanitizer_test/data --auth-local=trust

        # Configure PostgreSQL
        echo "port = 55433" >> tmp_sanitizer_test/data/postgresql.conf
        echo "unix_socket_directories = '$PWD/tmp_sanitizer_test'" >> tmp_sanitizer_test/data/postgresql.conf

        # Start PostgreSQL
        pg_ctl start -D tmp_sanitizer_test/data -l tmp_sanitizer_test/data/logfile -w

        # Create test database and run tests
        createdb -h $PWD/tmp_sanitizer_test -p 55433 contrib_regression
        make installcheck PGHOST=$PWD/tmp_sanitizer_test PGPORT=55433

        # Clean up
        pg_ctl stop -D tmp_sanitizer_test/data -l tmp_sanitizer_test/data/logfile

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sanitizer-test-failure-logs
        path: |
          test/regression.diffs
          tmp_sanitizer_test/data/logfile
