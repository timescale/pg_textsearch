name: Package Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag/Version (e.g. v0.0.1)'
        required: true
        type: string
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # Needed to upload assets to releases

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - type: amd64
            docker_platform: linux/amd64
          - type: arm64
            docker_platform: linux/arm64

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}

    - name: Set version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        fi
        echo "Building version: $VERSION"

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build extension in Docker
      run: |
        # Create a build script
        cat > build.sh << 'BUILDSCRIPT'
        #!/bin/bash
        set -ex

        # The TimescaleDB builder image should have build tools installed
        # Build the extension
        cd /build
        export PG_CONFIG=/usr/local/bin/pg_config
        make clean
        CFLAGS="-O3 -DNDEBUG" make

        # Package the extension
        bash scripts/package-deb.sh "$1" "$PWD" "$2"
        BUILDSCRIPT

        chmod +x build.sh

        # Run build in TimescaleDB container with proper architecture
        # Run as root to install dependencies
        docker run --rm \
          --platform ${{ matrix.platform.docker_platform }} \
          -v "$PWD:/build" \
          -w /build \
          --user root \
          timescale/timescaledb-ha:pg17-all \
          bash -c "apt-get update && apt-get install -y build-essential postgresql-server-dev-17 && /build/build.sh '$VERSION' '${{ matrix.platform.type }}'"

    - name: Verify package architecture
      run: |
        # Extract and check the actual binary architecture
        mkdir -p check-arch
        dpkg-deb -x dist/*.deb check-arch/
        file check-arch/usr/lib/postgresql/*/lib/pg_textsearch.so | grep -E "(x86-64|aarch64)" || true
        rm -rf check-arch

    - name: Create zip archive
      run: |
        cd dist
        # Create zip with the expected naming convention for timescaledb-docker-cloud
        zip pg-textsearch-${{ env.VERSION }}-pg17-${{ matrix.platform.type }}.zip *.deb
        cd ..

    - name: Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pg-textsearch-${{ env.VERSION }}-pg17-${{ matrix.platform.type }}
        path: |
          dist/*.deb
          dist/*.zip
        retention-days: 30

  build-source:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag || github.ref }}

    - name: Set version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        fi
        echo "Building version: $VERSION"

    - name: Create source tarball
      run: |
        # Clean version without 'v' prefix
        CLEAN_VERSION=${VERSION#v}

        # Create directory with version
        mkdir -p pg_textsearch-${CLEAN_VERSION}

        # Copy source files
        cp -r src sql test benchmarks Makefile pg_textsearch.control README.md LICENSE pg_textsearch-${CLEAN_VERSION}/

        # Create tarball
        tar -czf pg_textsearch-${CLEAN_VERSION}.tar.gz pg_textsearch-${CLEAN_VERSION}/

        # Also create a .tar.bz2
        tar -cjf pg_textsearch-${CLEAN_VERSION}.tar.bz2 pg_textsearch-${CLEAN_VERSION}/

        mkdir -p dist
        mv pg_textsearch-${CLEAN_VERSION}.tar.* dist/

    - name: Upload source artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pg-textsearch-source-${{ env.VERSION }}
        path: dist/pg_textsearch-*.tar.*
        retention-days: 30

  release:
    needs: [build-packages, build-source]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Upload Release Assets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"

        # Check if release exists, create if it doesn't
        if ! gh release view "$TAG_NAME" &>/dev/null; then
          echo "Creating release for tag $TAG_NAME"
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes "Release $TAG_NAME" \
            --draft
        fi

        # Upload all .deb, .zip, and source packages
        for file in artifacts/*/*.deb artifacts/*/*.zip artifacts/*/*.tar.*; do
          if [ -f "$file" ]; then
            echo "Uploading $(basename "$file") to release $TAG_NAME"
            gh release upload "$TAG_NAME" "$file" --clobber
          fi
        done
