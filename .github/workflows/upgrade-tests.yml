name: Upgrade Tests

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target version to test upgrades to (leave empty for current branch)'
        required: false
        type: string
  pull_request:
    paths:
      - 'sql/**'
      - 'pg_textsearch.control'
      - '.github/workflows/upgrade-tests.yml'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  test-upgrades:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_version: [17, 18]
        # Test upgrades from compatible releases only.
        # Note: 0.1.0 and earlier are not upgrade-compatible due to:
        #   - Metapage version change (v4 -> v5)
        #   - Shared memory structure size changes
        # Users on 0.1.0 must recreate indexes after upgrading.
        old_version: ['0.2.0']

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Download old release v${{ matrix.old_version }}
      id: download
      run: |
        # Download the source tarball from GitHub releases
        DOWNLOAD_URL="https://github.com/timescale/pg_textsearch/releases/download/v${{ matrix.old_version }}/pg_textsearch-${{ matrix.old_version }}.tar.gz"
        echo "Downloading from: $DOWNLOAD_URL"
        if curl -fsSL -o pg_textsearch-old.tar.gz "$DOWNLOAD_URL"; then
          echo "downloaded=true" >> $GITHUB_OUTPUT
          tar -xzf pg_textsearch-old.tar.gz
          ls -la
        else
          echo "::error::Failed to download v${{ matrix.old_version }}"
          echo "downloaded=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Build old version v${{ matrix.old_version }}
      run: |
        cd pg_textsearch-${{ matrix.old_version }}
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean || true
        make
        sudo make install
        cd ..

    - name: Build current version
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make

    - name: Start PostgreSQL and create test database
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/upgrade_test_data

        initdb -D $PGDATA
        echo "shared_buffers = 256MB" >> $PGDATA/postgresql.conf
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp upgrade_test

    - name: Install old extension and create test data
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        psql -h /tmp -d upgrade_test << 'SQL'
        -- Install old version
        CREATE EXTENSION pg_textsearch VERSION '${{ matrix.old_version }}';

        -- Check installed version
        SELECT extversion AS old_version FROM pg_extension WHERE extname = 'pg_textsearch';

        -- Create test table with documents
        CREATE TABLE upgrade_docs (
          id SERIAL PRIMARY KEY,
          content TEXT NOT NULL
        );

        INSERT INTO upgrade_docs (content) VALUES
          ('PostgreSQL is a powerful open source database system'),
          ('Full text search with BM25 ranking provides relevance scoring'),
          ('The quick brown fox jumps over the lazy dog'),
          ('Database indexing improves query performance significantly'),
          ('Search engines use inverted indexes for fast lookups');

        -- Create BM25 index
        CREATE INDEX idx_upgrade_bm25 ON upgrade_docs
          USING bm25 (content) WITH (text_config = 'english');

        -- Run a query and save results for comparison
        CREATE TABLE pre_upgrade_results AS
        SELECT id, content <@> 'database search'::text AS score
        FROM upgrade_docs
        ORDER BY score
        LIMIT 5;

        SELECT * FROM pre_upgrade_results;
        SQL

    - name: Upgrade extension to current version
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

        # Install current version files
        sudo make install

        # Perform the upgrade
        psql -h /tmp -d upgrade_test << 'SQL'
        -- Upgrade extension
        ALTER EXTENSION pg_textsearch UPDATE;

        -- Verify new version
        SELECT extversion AS new_version FROM pg_extension WHERE extname = 'pg_textsearch';
        SQL

    - name: Verify upgrade succeeded
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        psql -h /tmp -d upgrade_test << 'SQL'
        -- Verify extension upgraded to expected version
        DO $$
        DECLARE
          ver text;
        BEGIN
          SELECT extversion INTO ver FROM pg_extension WHERE extname = 'pg_textsearch';
          IF ver NOT LIKE '0.3%' THEN
            RAISE EXCEPTION 'Extension did not upgrade properly. Version: %', ver;
          END IF;
          RAISE NOTICE 'Extension upgraded to version: %', ver;
        END $$;

        -- Verify BM25 queries still work
        SELECT id, content <@> 'database search'::text AS score
        FROM upgrade_docs
        ORDER BY score
        LIMIT 3;

        -- Verify scores are negative (BM25 returns negative scores for ASC ordering)
        DO $$
        DECLARE
          score_val float8;
        BEGIN
          SELECT content <@> 'database search'::text INTO score_val
          FROM upgrade_docs
          LIMIT 1;
          IF score_val >= 0 THEN
            RAISE EXCEPTION 'BM25 score should be negative, got: %', score_val;
          END IF;
          RAISE NOTICE 'BM25 scoring working correctly, sample score: %', score_val;
        END $$;

        -- Verify index is still usable (EXPLAIN should show index scan)
        EXPLAIN (COSTS OFF)
        SELECT * FROM upgrade_docs
        ORDER BY content <@> 'database'::text
        LIMIT 5;

        -- Test inserting new data after upgrade
        INSERT INTO upgrade_docs (content) VALUES
          ('New document added after upgrade to test index updates');

        -- Query should include new document
        SELECT id, content <@> 'upgrade'::text AS score
        FROM upgrade_docs
        WHERE content <@> 'upgrade'::text < 0
        ORDER BY score
        LIMIT 3;

        -- Test creating a new index after upgrade
        CREATE TABLE post_upgrade_docs (content TEXT);
        INSERT INTO post_upgrade_docs VALUES ('Testing post-upgrade index creation');
        CREATE INDEX idx_post_upgrade ON post_upgrade_docs
          USING bm25 (content) WITH (text_config = 'english');

        SELECT content <@> 'testing'::text AS score FROM post_upgrade_docs;

        RAISE NOTICE 'All upgrade verification checks passed!';
        SQL

    - name: Cleanup
      if: always()
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        pg_ctl -D /tmp/upgrade_test_data stop -m immediate || true
        rm -rf /tmp/upgrade_test_data

  # Test that incompatible upgrades fail gracefully (no crash, proper error message)
  test-incompatible-upgrade:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_version: [17]
        # Old versions with incompatible on-disk format
        old_version: ['0.1.0']

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Download old release v${{ matrix.old_version }}
      run: |
        DOWNLOAD_URL="https://github.com/timescale/pg_textsearch/releases/download/v${{ matrix.old_version }}/pg_textsearch-${{ matrix.old_version }}.tar.gz"
        curl -fsSL -o pg_textsearch-old.tar.gz "$DOWNLOAD_URL"
        tar -xzf pg_textsearch-old.tar.gz

    - name: Build old version v${{ matrix.old_version }}
      run: |
        cd pg_textsearch-${{ matrix.old_version }}
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean || true
        make
        sudo make install
        cd ..

    - name: Build current version
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make

    - name: Start PostgreSQL and create test data with old version
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/incompat_test_data

        initdb -D $PGDATA
        echo "shared_buffers = 256MB" >> $PGDATA/postgresql.conf
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp incompat_test

        psql -h /tmp -d incompat_test << 'SQL'
        CREATE EXTENSION pg_textsearch VERSION '${{ matrix.old_version }}';
        SELECT extversion AS old_version FROM pg_extension WHERE extname = 'pg_textsearch';

        CREATE TABLE test_docs (id SERIAL PRIMARY KEY, content TEXT);
        INSERT INTO test_docs (content) VALUES
          ('PostgreSQL database system'),
          ('Full text search ranking'),
          ('Document indexing test');

        CREATE INDEX idx_old ON test_docs USING bm25 (content) WITH (text_config = 'english');

        -- Verify it works before upgrade
        SELECT id, content <@> 'database'::text AS score FROM test_docs ORDER BY score LIMIT 1;
        SQL

    - name: Stop PostgreSQL, upgrade extension, restart
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

        # Stop server
        pg_ctl -D /tmp/incompat_test_data stop -w

        # Install new version
        sudo make install

        # Restart server with new code
        pg_ctl -D /tmp/incompat_test_data start -w -l /tmp/incompat_test_data/logfile

    - name: Verify incompatible index fails gracefully
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        # Upgrade the extension
        psql -h /tmp -d incompat_test -c "ALTER EXTENSION pg_textsearch UPDATE;"
        psql -h /tmp -d incompat_test -c "SELECT extversion FROM pg_extension WHERE extname = 'pg_textsearch';"

        # Try to use the old index - should get an error, NOT a crash
        # We use a script that captures the error and verifies it's the expected message
        psql -h /tmp -d incompat_test << 'SQLSCRIPT'
        -- This should produce an error about incompatible index version
        \set ON_ERROR_STOP off

        DO $$
        DECLARE
          result float8;
          err_msg text;
        BEGIN
          BEGIN
            SELECT content <@> 'database'::text INTO result FROM test_docs LIMIT 1;
            RAISE EXCEPTION 'Expected an error but query succeeded with result: %', result;
          EXCEPTION WHEN OTHERS THEN
            GET STACKED DIAGNOSTICS err_msg = MESSAGE_TEXT;
            -- Check that we got a proper error message about version incompatibility
            IF err_msg LIKE '%ncompatible%version%' OR err_msg LIKE '%recreate%' OR err_msg LIKE '%rebuild%' THEN
              RAISE NOTICE 'Got expected error: %', err_msg;
            ELSE
              RAISE EXCEPTION 'Unexpected error message: %', err_msg;
            END IF;
          END;
        END $$;

        -- Verify server is still running (didn't crash)
        SELECT 'Server still running after incompatible index access' as status;

        -- Verify we can create NEW indexes with the new version
        CREATE TABLE new_docs (content TEXT);
        INSERT INTO new_docs VALUES ('Testing new index creation after upgrade');
        CREATE INDEX idx_new ON new_docs USING bm25 (content) WITH (text_config = 'english');
        SELECT content <@> 'testing'::text AS score FROM new_docs;
        RAISE NOTICE 'New index creation works correctly';

        -- Verify REINDEX fixes the old index
        REINDEX INDEX idx_old;
        SELECT id, content <@> 'database'::text AS score FROM test_docs ORDER BY score LIMIT 1;
        RAISE NOTICE 'REINDEX successfully rebuilt incompatible index';
        SQLSCRIPT

        echo "Incompatible upgrade handled gracefully!"

    - name: Cleanup
      if: always()
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        pg_ctl -D /tmp/incompat_test_data stop -m immediate || true
        rm -rf /tmp/incompat_test_data

  # Test clean install (no upgrade) on both PG versions
  test-clean-install:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [17, 18]

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Build and install
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make
        sudo make install

    - name: Test clean installation
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/clean_test_data

        initdb -D $PGDATA
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp clean_test

        psql -h /tmp -d clean_test << 'SQL'
        CREATE EXTENSION pg_textsearch;

        -- Verify version
        SELECT extversion FROM pg_extension WHERE extname = 'pg_textsearch';

        -- Basic functionality test
        CREATE TABLE docs (id SERIAL PRIMARY KEY, content TEXT);
        INSERT INTO docs (content) VALUES
          ('PostgreSQL full text search'),
          ('BM25 ranking algorithm'),
          ('Document retrieval system');

        CREATE INDEX idx_docs ON docs USING bm25 (content) WITH (text_config = 'english');

        -- Test query
        SELECT id, content <@> 'search ranking'::text AS score
        FROM docs
        ORDER BY score
        LIMIT 3;

        RAISE NOTICE 'Clean installation test passed!';
        SQL

        pg_ctl -D $PGDATA stop -m immediate
        rm -rf $PGDATA
