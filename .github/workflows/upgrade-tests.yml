name: Upgrade Tests

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target version to test upgrades to (leave empty for current branch)'
        required: false
        type: string
  pull_request:
    paths:
      - 'sql/**'
      - 'pg_textsearch.control'
      - '.github/workflows/upgrade-tests.yml'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  test-upgrades:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_version: [17, 18]
        # Test upgrades from compatible releases only.
        # Note: 0.1.0 and earlier are not upgrade-compatible due to:
        #   - Metapage version change (v4 -> v5)
        #   - Shared memory structure size changes
        # Users on 0.1.0 must recreate indexes after upgrading.
        old_version: ['0.2.0']

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Download old release v${{ matrix.old_version }}
      id: download
      run: |
        # Download the source tarball from GitHub releases
        DOWNLOAD_URL="https://github.com/timescale/pg_textsearch/releases/download/v${{ matrix.old_version }}/pg_textsearch-${{ matrix.old_version }}.tar.gz"
        echo "Downloading from: $DOWNLOAD_URL"
        if curl -fsSL -o pg_textsearch-old.tar.gz "$DOWNLOAD_URL"; then
          echo "downloaded=true" >> $GITHUB_OUTPUT
          tar -xzf pg_textsearch-old.tar.gz
          ls -la
        else
          echo "::error::Failed to download v${{ matrix.old_version }}"
          echo "downloaded=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Build old version v${{ matrix.old_version }}
      run: |
        cd pg_textsearch-${{ matrix.old_version }}
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean || true
        make
        sudo make install
        cd ..

    - name: Build current version
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make

    - name: Start PostgreSQL and create test database
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/upgrade_test_data

        initdb -D $PGDATA
        echo "shared_buffers = 256MB" >> $PGDATA/postgresql.conf
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp upgrade_test

    - name: Install old extension and create test data
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        psql -h /tmp -d upgrade_test << 'SQL'
        -- Install old version
        CREATE EXTENSION pg_textsearch VERSION '${{ matrix.old_version }}';

        -- Check installed version
        SELECT extversion AS old_version FROM pg_extension WHERE extname = 'pg_textsearch';

        -- Create test table with documents
        CREATE TABLE upgrade_docs (
          id SERIAL PRIMARY KEY,
          content TEXT NOT NULL
        );

        INSERT INTO upgrade_docs (content) VALUES
          ('PostgreSQL is a powerful open source database system'),
          ('Full text search with BM25 ranking provides relevance scoring'),
          ('The quick brown fox jumps over the lazy dog'),
          ('Database indexing improves query performance significantly'),
          ('Search engines use inverted indexes for fast lookups');

        -- Create BM25 index
        CREATE INDEX idx_upgrade_bm25 ON upgrade_docs
          USING bm25 (content) WITH (text_config = 'english');

        -- Run a query and save results for comparison
        CREATE TABLE pre_upgrade_results AS
        SELECT id, content <@> 'database search'::text AS score
        FROM upgrade_docs
        ORDER BY score
        LIMIT 5;

        SELECT * FROM pre_upgrade_results;
        SQL

    - name: Upgrade extension to current version
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

        # Install current version files
        sudo make install

        # Perform the upgrade
        psql -h /tmp -d upgrade_test << 'SQL'
        -- Upgrade extension
        ALTER EXTENSION pg_textsearch UPDATE;

        -- Verify new version
        SELECT extversion AS new_version FROM pg_extension WHERE extname = 'pg_textsearch';
        SQL

    - name: Verify upgrade succeeded
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        psql -h /tmp -d upgrade_test << 'SQL'
        \set ON_ERROR_STOP on

        -- Test 1: Verify extension upgraded to expected version
        DO $$
        DECLARE
          ver text;
        BEGIN
          SELECT extversion INTO ver FROM pg_extension WHERE extname = 'pg_textsearch';
          IF ver NOT LIKE '0.3%' THEN
            RAISE EXCEPTION 'FAIL: Extension did not upgrade properly. Version: %', ver;
          END IF;
          RAISE NOTICE 'PASS: Extension upgraded to version: %', ver;
        END $$;

        -- Test 2: Verify BM25 index scan works with ORDER BY ... LIMIT
        -- Note: Must use explicit to_bm25query() in PL/pgSQL - implicit resolution doesn't work
        DO $$
        DECLARE
          rec record;
        BEGIN
          SELECT * INTO rec FROM upgrade_docs
          ORDER BY content <@> to_bm25query('database', 'idx_upgrade_bm25') LIMIT 1;
          IF rec.id IS NULL THEN
            RAISE EXCEPTION 'FAIL: Query returned no results';
          END IF;
          RAISE NOTICE 'PASS: BM25 query works, got id=%', rec.id;
        END $$;

        -- Test 3: Verify scores are negative (BM25 returns negative for ASC)
        DO $$
        DECLARE
          score_val float8;
        BEGIN
          SELECT content <@> to_bm25query('database', 'idx_upgrade_bm25') INTO score_val
          FROM upgrade_docs
          ORDER BY 1 LIMIT 1;
          IF score_val IS NULL OR score_val >= 0 THEN
            RAISE EXCEPTION 'FAIL: BM25 score should be negative, got: %', score_val;
          END IF;
          RAISE NOTICE 'PASS: BM25 scoring correct, score=%', score_val;
        END $$;

        -- Test 4: Verify index scan is used (check EXPLAIN output)
        DO $$
        DECLARE
          plan_text text;
        BEGIN
          SELECT string_agg(t, E'\n') INTO plan_text
          FROM (
            SELECT t FROM unnest(ARRAY(
              EXPLAIN (COSTS OFF)
              SELECT * FROM upgrade_docs
              ORDER BY content <@> to_bm25query('database', 'idx_upgrade_bm25')
              LIMIT 5
            )) AS t
          ) sub;
          IF plan_text NOT LIKE '%Index Scan%' THEN
            RAISE WARNING 'Index scan not used (may be OK for small tables): %', plan_text;
          ELSE
            RAISE NOTICE 'PASS: Index scan used in query plan';
          END IF;
        END $$;

        -- Test 5: Insert new data and verify it's searchable
        INSERT INTO upgrade_docs (content) VALUES
          ('New document added after upgrade to test index updates');

        DO $$
        DECLARE
          rec record;
        BEGIN
          SELECT * INTO rec FROM upgrade_docs
          ORDER BY content <@> to_bm25query('upgrade', 'idx_upgrade_bm25') LIMIT 1;
          IF rec.id IS NULL THEN
            RAISE EXCEPTION 'FAIL: Could not find newly inserted document';
          END IF;
          RAISE NOTICE 'PASS: New document searchable, id=%', rec.id;
        END $$;

        -- Test 6: Create new index after upgrade
        CREATE TABLE post_upgrade_docs (content TEXT);
        INSERT INTO post_upgrade_docs VALUES ('Testing post-upgrade index creation');
        CREATE INDEX idx_post_upgrade ON post_upgrade_docs
          USING bm25 (content) WITH (text_config = 'english');

        DO $$
        DECLARE
          score_val float8;
        BEGIN
          SELECT content <@> to_bm25query('testing', 'idx_post_upgrade') INTO score_val
          FROM post_upgrade_docs
          ORDER BY 1 LIMIT 1;
          IF score_val IS NULL OR score_val >= 0 THEN
            RAISE EXCEPTION 'FAIL: New index query failed, score=%', score_val;
          END IF;
          RAISE NOTICE 'PASS: New index works, score=%', score_val;
        END $$;

        SELECT 'All compatible upgrade tests passed!' as final_status;
        SQL

    - name: Cleanup
      if: always()
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        pg_ctl -D /tmp/upgrade_test_data stop -m immediate || true
        rm -rf /tmp/upgrade_test_data

  # Test that incompatible upgrades fail gracefully (no crash, proper error message)
  test-incompatible-upgrade:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_version: [17]
        # Old versions with incompatible on-disk format
        old_version: ['0.1.0']

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Download old release v${{ matrix.old_version }}
      run: |
        DOWNLOAD_URL="https://github.com/timescale/pg_textsearch/releases/download/v${{ matrix.old_version }}/pg_textsearch-${{ matrix.old_version }}.tar.gz"
        curl -fsSL -o pg_textsearch-old.tar.gz "$DOWNLOAD_URL"
        tar -xzf pg_textsearch-old.tar.gz

    - name: Build old version v${{ matrix.old_version }}
      run: |
        cd pg_textsearch-${{ matrix.old_version }}
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean || true
        make
        sudo make install
        cd ..

    - name: Build current version
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make

    - name: Start PostgreSQL and create test data with old version
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/incompat_test_data

        initdb -D $PGDATA
        echo "shared_buffers = 256MB" >> $PGDATA/postgresql.conf
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp incompat_test

        psql -h /tmp -d incompat_test << 'SQL'
        CREATE EXTENSION pg_textsearch VERSION '${{ matrix.old_version }}';
        SELECT extversion AS old_version FROM pg_extension WHERE extname = 'pg_textsearch';

        CREATE TABLE test_docs (id SERIAL PRIMARY KEY, content TEXT);
        INSERT INTO test_docs (content) VALUES
          ('PostgreSQL database system'),
          ('Full text search ranking'),
          ('Document indexing test');

        CREATE INDEX idx_old ON test_docs USING bm25 (content) WITH (text_config = 'english');

        -- Verify it works before upgrade
        SELECT id, content <@> 'database'::text AS score FROM test_docs ORDER BY score LIMIT 1;
        SQL

    - name: Stop PostgreSQL, upgrade extension, restart
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

        # Stop server
        pg_ctl -D /tmp/incompat_test_data stop -w

        # Install new version
        sudo make install

        # Restart server with new code
        pg_ctl -D /tmp/incompat_test_data start -w -l /tmp/incompat_test_data/logfile

    - name: Verify incompatible index fails gracefully
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH

        # Upgrade the extension
        psql -h /tmp -d incompat_test -c "ALTER EXTENSION pg_textsearch UPDATE;"
        psql -h /tmp -d incompat_test -c "SELECT extversion FROM pg_extension WHERE extname = 'pg_textsearch';"

        # Try to use the old index - this should get an error about incompatible version, NOT a crash
        # Note: Must use explicit to_bm25query() in PL/pgSQL - implicit resolution doesn't work
        psql -h /tmp -d incompat_test << 'SQLSCRIPT'
        \set ON_ERROR_STOP on

        -- Test 1: Verify incompatible index produces proper error (not crash)
        DO $$
        DECLARE
          rec record;
          err_msg text;
        BEGIN
          BEGIN
            SELECT * INTO rec FROM test_docs
            ORDER BY content <@> to_bm25query('database', 'idx_old') LIMIT 1;
            RAISE EXCEPTION 'Expected an error but query succeeded';
          EXCEPTION WHEN OTHERS THEN
            GET STACKED DIAGNOSTICS err_msg = MESSAGE_TEXT;
            -- Verify we got a version incompatibility error
            IF err_msg LIKE '%Incompatible%version%' OR err_msg LIKE '%drop and recreate%' THEN
              RAISE NOTICE 'PASS: Got expected incompatibility error: %', err_msg;
            ELSE
              RAISE EXCEPTION 'FAIL: Expected incompatibility error but got: %', err_msg;
            END IF;
          END;
        END $$;

        -- Test 2: Verify server is still running (didn't crash)
        SELECT 'PASS: Server still running after incompatible index access' as status;

        -- Test 3: Verify we can create NEW indexes with the new version
        CREATE TABLE new_docs (content TEXT);
        INSERT INTO new_docs VALUES ('Testing new index creation after upgrade');
        CREATE INDEX idx_new ON new_docs USING bm25 (content) WITH (text_config = 'english');

        DO $$
        DECLARE
          score float8;
        BEGIN
          SELECT content <@> to_bm25query('testing', 'idx_new') INTO score
          FROM new_docs ORDER BY 1 LIMIT 1;
          IF score IS NOT NULL AND score < 0 THEN
            RAISE NOTICE 'PASS: New index creation works, score=%', score;
          ELSE
            RAISE EXCEPTION 'FAIL: New index query returned unexpected score: %', score;
          END IF;
        END $$;

        -- Test 4: Verify REINDEX fixes the old index
        REINDEX INDEX idx_old;

        DO $$
        DECLARE
          rec record;
        BEGIN
          SELECT * INTO rec FROM test_docs
          ORDER BY content <@> to_bm25query('database', 'idx_old') LIMIT 1;
          IF rec.id IS NOT NULL THEN
            RAISE NOTICE 'PASS: REINDEX fixed incompatible index, got id=%', rec.id;
          ELSE
            RAISE EXCEPTION 'FAIL: Query after REINDEX returned no results';
          END IF;
        END $$;

        SELECT 'All incompatible upgrade tests passed!' as final_status;
        SQLSCRIPT

        echo "Incompatible upgrade handled gracefully!"

    - name: Cleanup
      if: always()
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        pg_ctl -D /tmp/incompat_test_data stop -m immediate || true
        rm -rf /tmp/incompat_test_data

  # Test clean install (no upgrade) on both PG versions
  test-clean-install:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_version: [17, 18]

    steps:
    - name: Checkout current code
      uses: actions/checkout@v4

    - name: Install PostgreSQL ${{ matrix.pg_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates gnupg
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
        sudo systemctl stop postgresql

    - name: Build and install
      run: |
        export PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        make clean
        make
        sudo make install

    - name: Test clean installation
      run: |
        export PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH
        export PGDATA=/tmp/clean_test_data

        initdb -D $PGDATA
        echo "port = 5432" >> $PGDATA/postgresql.conf
        echo "unix_socket_directories = '/tmp'" >> $PGDATA/postgresql.conf

        pg_ctl -D $PGDATA start -w -l $PGDATA/logfile
        createdb -h /tmp clean_test

        psql -h /tmp -d clean_test << 'SQL'
        CREATE EXTENSION pg_textsearch;

        -- Verify version
        SELECT extversion FROM pg_extension WHERE extname = 'pg_textsearch';

        -- Basic functionality test
        CREATE TABLE docs (id SERIAL PRIMARY KEY, content TEXT);
        INSERT INTO docs (content) VALUES
          ('PostgreSQL full text search'),
          ('BM25 ranking algorithm'),
          ('Document retrieval system');

        CREATE INDEX idx_docs ON docs USING bm25 (content) WITH (text_config = 'english');

        -- Test query
        SELECT id, content <@> 'search ranking'::text AS score
        FROM docs
        ORDER BY score
        LIMIT 3;

        RAISE NOTICE 'Clean installation test passed!';
        SQL

        pg_ctl -D $PGDATA stop -m immediate
        rm -rf $PGDATA
