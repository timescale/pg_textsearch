<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pg_textsearch Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; margin-bottom: 15px; }
        .description {
            color: #666;
            margin-bottom: 20px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 800px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        canvas { max-height: 250px; }
        .dataset-section {
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
    <h1>pg_textsearch Benchmarks</h1>
    <p class="description">
        Performance tracking for <a href="https://github.com/timescale/pg_textsearch">pg_textsearch</a>.
        Click any data point to view the commit.
        <br>
        <a href="profiles/">üìä CPU Profiles &amp; Flamegraphs</a>
    </p>
    <div id="charts"></div>

    <script src="./data.js"></script>
    <script>
        const colors = [
            'rgb(54, 162, 235)',
            'rgb(255, 99, 132)',
            'rgb(75, 192, 192)',
            'rgb(255, 159, 64)',
            'rgb(153, 102, 255)',
            'rgb(255, 205, 86)',
            'rgb(201, 203, 207)',
            'rgb(255, 99, 71)',
        ];

        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: '2-digit'
            });
        }

        function formatCommit(hash) {
            return hash ? hash.substring(0, 7) : '';
        }

        function getUnit(metricName, defaultUnit) {
            if (metricName.includes('Index Size')) return 'MB';
            return defaultUnit || 'ms';
        }

        function createChart(container, metricName, data, colorIdx) {
            const div = document.createElement('div');
            div.className = 'chart-container';

            const canvas = document.createElement('canvas');
            div.appendChild(canvas);
            container.appendChild(div);

            const unit = getUnit(metricName, data[0]?.unit || 'ms');

            new Chart(canvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: metricName,
                        data: data,
                        borderColor: colors[colorIdx % colors.length],
                        backgroundColor: colors[colorIdx % colors.length] + '33',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: metricName,
                            font: { size: 13, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const item = items[0];
                                    const date = formatDate(item.raw.date);
                                    const commit = formatCommit(item.raw.commit);
                                    return `${date} (${commit})`;
                                },
                                label: (item) => {
                                    return `${item.raw.y.toFixed(2)} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            title: {
                                display: false
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: unit,
                                font: { size: 10 }
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const commit = data[idx].commit;
                            if (commit) {
                                const shortCommit = commit.substring(0, 7);
                                // Show a small menu with commit and profile links
                                const menu = document.createElement('div');
                                menu.style.cssText = 'position:fixed;background:white;border:1px solid #ccc;border-radius:4px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:1000;';
                                menu.innerHTML = `
                                    <div style="margin-bottom:8px;font-weight:bold;color:#333;">Commit ${shortCommit}</div>
                                    <a href="https://github.com/timescale/pg_textsearch/commit/${commit}" target="_blank" style="display:block;padding:4px 8px;color:#0066cc;text-decoration:none;">üìù View Commit</a>
                                    <a href="profiles/main/${shortCommit}/" target="_blank" style="display:block;padding:4px 8px;color:#0066cc;text-decoration:none;">üìä Profile (main)</a>
                                    <a href="profiles/block-storage-phase1/${shortCommit}/" target="_blank" style="display:block;padding:4px 8px;color:#0066cc;text-decoration:none;">üìä Profile (block-storage-phase1)</a>
                                    <a href="profiles/" target="_blank" style="display:block;padding:4px 8px;color:#999;text-decoration:none;font-size:12px;">Browse all profiles...</a>
                                `;
                                menu.style.left = event.native.pageX + 'px';
                                menu.style.top = event.native.pageY + 'px';
                                document.body.appendChild(menu);

                                const closeMenu = (e) => {
                                    if (!menu.contains(e.target)) {
                                        menu.remove();
                                        document.removeEventListener('click', closeMenu);
                                    }
                                };
                                setTimeout(() => document.addEventListener('click', closeMenu), 100);
                            }
                        }
                    }
                }
            });
        }

        // Render charts for each benchmark suite
        if (typeof window.BENCHMARK_DATA !== 'undefined') {
            const container = document.getElementById('charts');

            Object.entries(window.BENCHMARK_DATA.entries).forEach(([suiteName, suiteData]) => {
                // Create section for this benchmark suite
                const section = document.createElement('div');
                section.className = 'dataset-section';

                const header = document.createElement('h2');
                header.textContent = suiteName;
                section.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'charts-grid';
                section.appendChild(grid);

                // Group data by metric name
                const metrics = {};
                suiteData.forEach(run => {
                    run.benches.forEach(bench => {
                        if (!metrics[bench.name]) {
                            metrics[bench.name] = [];
                        }
                        metrics[bench.name].push({
                            x: run.date,
                            y: bench.value,
                            unit: bench.unit,
                            commit: run.commit.id,
                            date: run.date
                        });
                    });
                });

                // Create a chart for each metric
                Object.entries(metrics).forEach(([metricName, data], idx) => {
                    createChart(grid, metricName, data, idx);
                });

                container.appendChild(section);
            });
        } else {
            document.getElementById('charts').innerHTML =
                '<p>No benchmark data available yet. Run a benchmark workflow to generate data.</p>';
        }
    </script>
</body>
</html>
