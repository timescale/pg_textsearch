#!/usr/bin/env python3
"""
Memory usage visualization for pg_textsearch benchmarks
Plots memory usage over time from CSV files generated by the advanced benchmark
"""

import sys
import pandas as pd
import matplotlib.pyplot as plt
from pathlib import Path


def plot_memory_usage(csv_files):
    """Plot memory usage from one or more CSV files"""
    fig, ax = plt.subplots(figsize=(12, 6))

    for csv_file in csv_files:
        if not Path(csv_file).exists():
            print(f"Warning: {csv_file} not found, skipping")
            continue

        # Read CSV
        df = pd.read_csv(csv_file)

        # Convert timestamp to relative seconds
        df['time'] = df['timestamp'] - df['timestamp'].min()

        # Plot RSS memory
        label = Path(csv_file).stem.replace('memory_', '').title()
        ax.plot(df['time'], df['rss_mb'], label=f'{label} (RSS)', marker='o', markersize=3)

        # If available, plot shared memory
        if 'shared_mb' in df.columns and df['shared_mb'].sum() > 0:
            ax.plot(df['time'], df['shared_mb'], label=f'{label} (Shared)',
                    linestyle='--', alpha=0.7)

    ax.set_xlabel('Time (seconds)')
    ax.set_ylabel('Memory Usage (MB)')
    ax.set_title('pg_textsearch Memory Usage During Benchmark')
    ax.grid(True, alpha=0.3)
    ax.legend()

    plt.tight_layout()
    output_file = 'memory_usage_plot.png'
    plt.savefig(output_file, dpi=150)
    print(f"Plot saved to {output_file}")
    plt.show()


def analyze_memory_stats(csv_files):
    """Print memory usage statistics"""
    print("\nMemory Usage Statistics")
    print("=" * 50)

    for csv_file in csv_files:
        if not Path(csv_file).exists():
            continue

        df = pd.read_csv(csv_file)
        phase = Path(csv_file).stem.replace('memory_', '').title()

        print(f"\n{phase} Phase:")
        print(f"  Peak RSS Memory:     {df['rss_mb'].max():.1f} MB")
        print(f"  Average RSS Memory:  {df['rss_mb'].mean():.1f} MB")
        print(f"  Min RSS Memory:      {df['rss_mb'].min():.1f} MB")

        if 'shared_mb' in df.columns and df['shared_mb'].sum() > 0:
            print(f"  Peak Shared Memory:  {df['shared_mb'].max():.1f} MB")
            print(f"  Avg Shared Memory:   {df['shared_mb'].mean():.1f} MB")

        # Calculate memory growth
        memory_growth = df['rss_mb'].iloc[-1] - df['rss_mb'].iloc[0]
        print(f"  Memory Growth:       {memory_growth:.1f} MB")

        # Duration
        duration = df['timestamp'].max() - df['timestamp'].min()
        print(f"  Duration:            {duration:.1f} seconds")


def main():
    if len(sys.argv) < 2:
        print("Usage: python3 plot_memory.py <memory_csv_file> [memory_csv_file2 ...]")
        print("Example: python3 plot_memory.py results/*/memory_*.csv")
        sys.exit(1)

    csv_files = sys.argv[1:]

    # Check if matplotlib is available
    try:
        plot_memory_usage(csv_files)
    except ImportError:
        print("matplotlib not installed. Install with: pip3 install matplotlib pandas")
        print("Showing statistics only...")

    # Always show statistics
    analyze_memory_stats(csv_files)


if __name__ == "__main__":
    main()
